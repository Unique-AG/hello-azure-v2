spec:
  name: backend-service-ingestion-worker
  autoSync: false
  sources:
    - repoURL: 'https://github.com/Unique-AG/hello-azure'
      targetRevision: preview
      ref: values
    - repoURL: ghcr.io/unique-ag/helm-charts
      chart: backend-service
      targetRevision: 6.0.1
      helm:
        releaseName: backend-service-ingestion-worker
        valueFiles:
          - $values/applications/defaults/backend-services/ingestion-worker.yaml
          - $values/applications/dev/values/backend-services/_all.yaml
          - $values/applications/dev/values/backend-services/ingestion-worker.yaml
        valuesObject:
          env:
            INGESTION_QUEUE: queue
          keda:
            enabled: true
            minReplicaCount: 0
            maxReplicaCount: 5
            triggers:
              # cron:
              #   type: cron
              #   metadata:
              #     timezone: Europe/Zurich
              #     start: 0 8 * * 1-5
              #     end: 0 18 * * 1-5
              #     desiredReplicas: "1" # NOTE: if there are no chat messages, we want to scale down to 1 replica otherwise it takes too long to scale up
              rabbitmq:
                type: rabbitmq
                metadata:
                  mode: QueueLength
                  protocol: http
                  queueName: unique.node.ingestion.queue
                  value: "0.9" # NOTE:means we want ceil(1/0.9) = 2 replicas, e.g. at 10 it will ceil to 12
                authenticationRef:
                  kind: TriggerAuthentication
                  name: rabbitmqcluster-chat-unique-user
  ignoreDifferences:
    - group: "apps"
      kind: Deployment
      jsonPointers:
        - /spec/replicas
