#!/bin/bash
# Terraform import commands for Day-2 resources
# Usage: ./import_azure_resources.sh test
#        ./import_azure_resources.sh dev

set -euo pipefail

ENV="${1:-test}"
VAR_CONFIG="../environments/${ENV}/00-config-day-2.auto.tfvars"
VAR_PARAMS="../environments/${ENV}/00-parameters-day-2.auto.tfvars"
SERVICE_PRINCIPAL_ID="5dbf19b3-6943-4696-9334-55b8c5566010"

echo "=========================================="
echo "Day-2 Resource Import Script"
echo "Environment: ${ENV}"
echo "=========================================="
echo ""
echo "⚠️  IMPORTANT: Before running this script, ensure:"
echo "   1. Day-1 resources have been imported/created (DNS zones, Key Vaults, etc.)"
echo "   2. terraform_service_principal_object_id is set in your tfvars file"
echo ""
echo "NOTE: azuread_application_password does NOT support import."
echo "      The password value is only available at creation time and cannot be"
echo "      retrieved from Azure AD. This resource will need to be created fresh"
echo "      or the password will be regenerated by Terraform."
echo ""

# Azure AD Groups
echo "Checking azuread_group.telemetry_observer..."
if ! terraform state show azuread_group.telemetry_observer >/dev/null 2>&1; then
  echo "  Importing azuread_group.telemetry_observer..."
  terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
    azuread_group.telemetry_observer \
    "/groups/3e60cd87-c622-44d7-801f-fc691822d0ca"
  echo "  ✓ Imported azuread_group.telemetry_observer"
else
  echo "  ✓ azuread_group.telemetry_observer already in state, skipping"
fi

echo "Checking azuread_group.devops..."
if ! terraform state show azuread_group.devops >/dev/null 2>&1; then
  echo "  Importing azuread_group.devops..."
  terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
    azuread_group.devops \
    "/groups/dfffea4f-9516-4a4d-ad56-b21c4f174b82"
  echo "  ✓ Imported azuread_group.devops"
else
  echo "  ✓ azuread_group.devops already in state, skipping"
fi

echo "Checking azuread_group.emergency_admin..."
if ! terraform state show azuread_group.emergency_admin >/dev/null 2>&1; then
  echo "  Importing azuread_group.emergency_admin..."
  terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
    azuread_group.emergency_admin \
    "/groups/3139d505-c738-49ca-8182-b9f4b334059b"
  echo "  ✓ Imported azuread_group.emergency_admin"
else
  echo "  ✓ azuread_group.emergency_admin already in state, skipping"
fi

echo "Checking azuread_group.admin_kubernetes_cluster..."
if ! terraform state show azuread_group.admin_kubernetes_cluster >/dev/null 2>&1; then
  echo "  Importing azuread_group.admin_kubernetes_cluster..."
  terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
    azuread_group.admin_kubernetes_cluster \
    "/groups/a435bed7-88b3-464f-bc3c-ba000d37ece5"
  echo "  ✓ Imported azuread_group.admin_kubernetes_cluster"
else
  echo "  ✓ azuread_group.admin_kubernetes_cluster already in state, skipping"
fi

echo "Checking azuread_group.main_keyvault_secret_writer..."
if ! terraform state show azuread_group.main_keyvault_secret_writer >/dev/null 2>&1; then
  echo "  Importing azuread_group.main_keyvault_secret_writer..."
  terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
    azuread_group.main_keyvault_secret_writer \
    "/groups/fa8f2e2c-154e-4d4a-a99c-7dfa825858ef"
  echo "  ✓ Imported azuread_group.main_keyvault_secret_writer"
else
  echo "  ✓ azuread_group.main_keyvault_secret_writer already in state, skipping"
fi

echo ""
echo "Importing Azure AD Service Principal and Application Registration resources..."
echo ""

# Azure AD Service Principal for Microsoft Graph
echo "Checking azuread_service_principal.msgraph..."
if ! terraform state show azuread_service_principal.msgraph >/dev/null 2>&1; then
  echo "  Importing azuread_service_principal.msgraph..."
  terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
    azuread_service_principal.msgraph \
    "/servicePrincipals/29c402c3-5bb1-4677-9a9b-80f77cd74944"
  echo "  ✓ Imported azuread_service_principal.msgraph"
else
  echo "  ✓ azuread_service_principal.msgraph already in state, skipping"
fi

# Application Registration Module Resources
echo "Checking module.application_registration.azuread_application.this..."
if ! terraform state show module.application_registration.azuread_application.this >/dev/null 2>&1; then
  echo "  Importing module.application_registration.azuread_application.this..."
  terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
    module.application_registration.azuread_application.this \
    "/applications/6f3b9b9b-c440-4696-883d-ea19a0a3b554"
  echo "  ✓ Imported module.application_registration.azuread_application.this"
else
  echo "  ✓ module.application_registration.azuread_application.this already in state, skipping"
fi

echo "Checking module.application_registration.azuread_service_principal.this..."
if ! terraform state show module.application_registration.azuread_service_principal.this >/dev/null 2>&1; then
  echo "  Importing module.application_registration.azuread_service_principal.this..."
  terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
    module.application_registration.azuread_service_principal.this \
    "/servicePrincipals/${SERVICE_PRINCIPAL_ID}"
  echo "  ✓ Imported module.application_registration.azuread_service_principal.this"
else
  echo "  ✓ module.application_registration.azuread_service_principal.this already in state, skipping"
fi

# Random UUID for maintainers role
echo "Checking module.application_registration.random_uuid.maintainers..."
if ! terraform state show module.application_registration.random_uuid.maintainers >/dev/null 2>&1; then
  echo "  Importing module.application_registration.random_uuid.maintainers..."
  terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
    module.application_registration.random_uuid.maintainers \
    "2ca08d18-0116-978f-bc4e-a110cc8a12d9"
  echo "  ✓ Imported module.application_registration.random_uuid.maintainers"
else
  echo "  ✓ module.application_registration.random_uuid.maintainers already in state, skipping"
fi

# Application App Roles
if ! terraform state show module.application_registration.azuread_application_app_role.maintainers >/dev/null 2>&1; then
  terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
    module.application_registration.azuread_application_app_role.maintainers \
    "/applications/6f3b9b9b-c440-4696-883d-ea19a0a3b554/appRoles/2ca08d18-0116-978f-bc4e-a110cc8a12d9"
fi

if ! terraform state show 'module.application_registration.azuread_application_app_role.managed_roles["application_support"]' >/dev/null 2>&1; then
  terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
    'module.application_registration.azuread_application_app_role.managed_roles["application_support"]' \
    "/applications/6f3b9b9b-c440-4696-883d-ea19a0a3b554/appRoles/719570d9-6707-40f4-9193-29ae0745392e"
fi

if ! terraform state show 'module.application_registration.azuread_application_app_role.managed_roles["infrastructure_support"]' >/dev/null 2>&1; then
  terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
    'module.application_registration.azuread_application_app_role.managed_roles["infrastructure_support"]' \
    "/applications/6f3b9b9b-c440-4696-883d-ea19a0a3b554/appRoles/0a7f4e66-4942-4a2e-a433-82e54464f116"
fi

if ! terraform state show 'module.application_registration.azuread_application_app_role.managed_roles["system_support"]' >/dev/null 2>&1; then
  terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
    'module.application_registration.azuread_application_app_role.managed_roles["system_support"]' \
    "/applications/6f3b9b9b-c440-4696-883d-ea19a0a3b554/appRoles/8719acef-9791-41e4-9621-92d05315181c"
fi

if ! terraform state show 'module.application_registration.azuread_application_app_role.managed_roles["user"]' >/dev/null 2>&1; then
  terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
    'module.application_registration.azuread_application_app_role.managed_roles["user"]' \
    "/applications/6f3b9b9b-c440-4696-883d-ea19a0a3b554/appRoles/6a902661-cfac-44f4-846c-bc5ceaa012d4"
fi

# App Role Assignments - Maintainers
if ! terraform state show 'module.application_registration.azuread_app_role_assignment.maintainers["084a1c45-5010-4aab-bab6-7b86a9d10e5c"]' >/dev/null 2>&1; then
  terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
    'module.application_registration.azuread_app_role_assignment.maintainers["084a1c45-5010-4aab-bab6-7b86a9d10e5c"]' \
    "/servicePrincipals/${SERVICE_PRINCIPAL_ID}/appRoleAssignedTo/RRxKCBBQq0q6tnuGqdEOXEeWO3NWueZItSB0uhLHfLQ"
fi

if ! terraform state show 'module.application_registration.azuread_app_role_assignment.maintainers["3b48f167-cb68-4655-b45b-878e170af84d"]' >/dev/null 2>&1; then
  terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
    'module.application_registration.azuread_app_role_assignment.maintainers["3b48f167-cb68-4655-b45b-878e170af84d"]' \
    "/servicePrincipals/${SERVICE_PRINCIPAL_ID}/appRoleAssignedTo/Z_FIO2jLVUa0W4eOFwr4TTafg3vVXT5Em4jqhTXUjt8"
fi

if ! terraform state show 'module.application_registration.azuread_app_role_assignment.maintainers["4b89a1f0-8038-4929-81e6-6d128dac7aa0"]' >/dev/null 2>&1; then
  terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
    'module.application_registration.azuread_app_role_assignment.maintainers["4b89a1f0-8038-4929-81e6-6d128dac7aa0"]' \
    "/servicePrincipals/${SERVICE_PRINCIPAL_ID}/appRoleAssignedTo/8KGJSziAKUmB5m0Sjax6oF3WDUAtnwpAhQJJAOJZjLQ"
fi

if ! terraform state show 'module.application_registration.azuread_app_role_assignment.maintainers["4ee4611f-b24c-444b-8d34-edab333bf868"]' >/dev/null 2>&1; then
  terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
    'module.application_registration.azuread_app_role_assignment.maintainers["4ee4611f-b24c-444b-8d34-edab333bf868"]' \
    "/servicePrincipals/${SERVICE_PRINCIPAL_ID}/appRoleAssignedTo/H2HkTkyyS0SNNO2rMzv4aEeaT8GgFQFCo2P1rtQyp3s"
fi

# App Role Assignments - Managed Roles (application_support)
if ! terraform state show 'module.application_registration.azuread_app_role_assignment.managed_roles["application_support:084a1c45-5010-4aab-bab6-7b86a9d10e5c"]' >/dev/null 2>&1; then
  terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
    'module.application_registration.azuread_app_role_assignment.managed_roles["application_support:084a1c45-5010-4aab-bab6-7b86a9d10e5c"]' \
    "/servicePrincipals/${SERVICE_PRINCIPAL_ID}/appRoleAssignedTo/RRxKCBBQq0q6tnuGqdEOXCe-72KXeWRBs_OM6Qk-K3A"
fi

if ! terraform state show 'module.application_registration.azuread_app_role_assignment.managed_roles["application_support:3b48f167-cb68-4655-b45b-878e170af84d"]' >/dev/null 2>&1; then
  terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
    'module.application_registration.azuread_app_role_assignment.managed_roles["application_support:3b48f167-cb68-4655-b45b-878e170af84d"]' \
    "/servicePrincipals/${SERVICE_PRINCIPAL_ID}/appRoleAssignedTo/Z_FIO2jLVUa0W4eOFwr4TdnphcTuf0xIqmODzGXHbBg"
fi

if ! terraform state show 'module.application_registration.azuread_app_role_assignment.managed_roles["application_support:4b89a1f0-8038-4929-81e6-6d128dac7aa0"]' >/dev/null 2>&1; then
  terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
    'module.application_registration.azuread_app_role_assignment.managed_roles["application_support:4b89a1f0-8038-4929-81e6-6d128dac7aa0"]' \
    "/servicePrincipals/${SERVICE_PRINCIPAL_ID}/appRoleAssignedTo/8KGJSziAKUmB5m0Sjax6oLIA2TWno25PoU_6NU8h3wE"
fi

if ! terraform state show 'module.application_registration.azuread_app_role_assignment.managed_roles["application_support:4ee4611f-b24c-444b-8d34-edab333bf868"]' >/dev/null 2>&1; then
  terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
    'module.application_registration.azuread_app_role_assignment.managed_roles["application_support:4ee4611f-b24c-444b-8d34-edab333bf868"]' \
    "/servicePrincipals/${SERVICE_PRINCIPAL_ID}/appRoleAssignedTo/H2HkTkyyS0SNNO2rMzv4aEvieKf9F0RJhH8NS1WYbUs"
fi

# App Role Assignments - Managed Roles (user)
if ! terraform state show 'module.application_registration.azuread_app_role_assignment.managed_roles["user:084a1c45-5010-4aab-bab6-7b86a9d10e5c"]' >/dev/null 2>&1; then
  terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
    'module.application_registration.azuread_app_role_assignment.managed_roles["user:084a1c45-5010-4aab-bab6-7b86a9d10e5c"]' \
    "/servicePrincipals/${SERVICE_PRINCIPAL_ID}/appRoleAssignedTo/RRxKCBBQq0q6tnuGqdEOXGbH1YDlewtDmQTItNgzE08"
fi

if ! terraform state show 'module.application_registration.azuread_app_role_assignment.managed_roles["user:3b48f167-cb68-4655-b45b-878e170af84d"]' >/dev/null 2>&1; then
  terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
    'module.application_registration.azuread_app_role_assignment.managed_roles["user:3b48f167-cb68-4655-b45b-878e170af84d"]' \
    "/servicePrincipals/${SERVICE_PRINCIPAL_ID}/appRoleAssignedTo/Z_FIO2jLVUa0W4eOFwr4TYRyzkPg6slBiQMy4oG5wZE"
fi

if ! terraform state show 'module.application_registration.azuread_app_role_assignment.managed_roles["user:4b89a1f0-8038-4929-81e6-6d128dac7aa0"]' >/dev/null 2>&1; then
  terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
    'module.application_registration.azuread_app_role_assignment.managed_roles["user:4b89a1f0-8038-4929-81e6-6d128dac7aa0"]' \
    "/servicePrincipals/${SERVICE_PRINCIPAL_ID}/appRoleAssignedTo/8KGJSziAKUmB5m0Sjax6oHhDPWazNnpMsDPxtUeOPB8"
fi

if ! terraform state show 'module.application_registration.azuread_app_role_assignment.managed_roles["user:4ee4611f-b24c-444b-8d34-edab333bf868"]' >/dev/null 2>&1; then
  terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
    'module.application_registration.azuread_app_role_assignment.managed_roles["user:4ee4611f-b24c-444b-8d34-edab333bf868"]' \
    "/servicePrincipals/${SERVICE_PRINCIPAL_ID}/appRoleAssignedTo/H2HkTkyyS0SNNO2rMzv4aHU7MVR2up9KnsngViZrQVQ"
fi

# Storage Accounts
echo ""
echo "=========================================="
echo "Storage Accounts"
echo "=========================================="
echo ""

# Extract storage account names and key vault name from variables
# Try to get from tfvars, otherwise use defaults
INGESTION_CACHE_SA_BASE=$(grep "^ingestion_cache_sa_name" "${VAR_PARAMS}" 2>/dev/null | cut -d'"' -f2 || echo "uqhacache")
INGESTION_STORAGE_SA_BASE=$(grep "^ingestion_storage_sa_name" "${VAR_PARAMS}" 2>/dev/null | cut -d'"' -f2 || echo "uqhastorage")
RESOURCE_GROUP_SENSITIVE=$(grep "^resource_group_sensitive_name" "${VAR_PARAMS}" 2>/dev/null | cut -d'"' -f2 || echo "")
SENSITIVE_KV_NAME=$(grep "^sensitive_kv_name" "${VAR_PARAMS}" 2>/dev/null | cut -d'"' -f2 || echo "")
ENV_NAME=$(grep "^env" "${VAR_PARAMS}" 2>/dev/null | head -1 | sed -E 's/^env\s*=\s*"?([^"]+)"?.*/\1/' | tr -d ' ' || echo "")

# Construct full storage account names (base + env)
INGESTION_CACHE_SA_NAME="${INGESTION_CACHE_SA_BASE}${ENV_NAME}"
INGESTION_STORAGE_SA_NAME="${INGESTION_STORAGE_SA_BASE}${ENV_NAME}"

if [ -z "${RESOURCE_GROUP_SENSITIVE}" ] || [ -z "${SENSITIVE_KV_NAME}" ] || [ -z "${ENV_NAME}" ]; then
  echo "⚠️  Key vault name, resource group, or environment not found in config files, skipping storage account imports"
  echo "   RESOURCE_GROUP_SENSITIVE: ${RESOURCE_GROUP_SENSITIVE:-<empty>}"
  echo "   SENSITIVE_KV_NAME: ${SENSITIVE_KV_NAME:-<empty>}"
  echo "   ENV_NAME: ${ENV_NAME:-<empty>}"
else
  SUBSCRIPTION_ID=$(az account show --query id -o tsv 2>/dev/null || echo "")
  if [ -z "${SUBSCRIPTION_ID}" ]; then
    echo "⚠️  Could not get Azure subscription ID, skipping storage account imports"
  else
    KEY_VAULT_NAME="${SENSITIVE_KV_NAME}${ENV_NAME}v2"
    
    # Import ingestion_cache storage account
    echo "Checking module.ingestion_cache.azurerm_storage_account.storage_account..."
    if ! terraform state show 'module.ingestion_cache.azurerm_storage_account.storage_account' >/dev/null 2>&1; then
      echo "  Importing module.ingestion_cache.azurerm_storage_account.storage_account..."
      terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
        'module.ingestion_cache.azurerm_storage_account.storage_account' \
        "/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP_SENSITIVE}/providers/Microsoft.Storage/storageAccounts/${INGESTION_CACHE_SA_NAME}"
      echo "  ✓ Imported module.ingestion_cache.azurerm_storage_account.storage_account"
    else
      echo "  ✓ module.ingestion_cache.azurerm_storage_account.storage_account already in state, skipping"
    fi

    # Import ingestion_cache Key Vault Key
    # Format: https://{vault-name}.vault.azure.net/keys/{key-name}/{version-id}
    echo "Checking module.ingestion_cache.azurerm_key_vault_key.storage-account-byok[0]..."
    if ! terraform state show 'module.ingestion_cache.azurerm_key_vault_key.storage-account-byok[0]' >/dev/null 2>&1; then
      KEY_VERSION=$(az keyvault key list-versions --vault-name "${KEY_VAULT_NAME}" --name "ingestion-cache-cmk" --query "[0].kid" -o tsv 2>/dev/null || echo "")
      if [ -n "${KEY_VERSION}" ]; then
        echo "  Importing module.ingestion_cache.azurerm_key_vault_key.storage-account-byok[0]..."
        terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
          'module.ingestion_cache.azurerm_key_vault_key.storage-account-byok[0]' \
          "${KEY_VERSION}"
        echo "  ✓ Imported module.ingestion_cache.azurerm_key_vault_key.storage-account-byok[0]"
      else
        echo "  ⚠️  Could not determine key version for ingestion-cache-cmk, skipping import"
        echo "      You may need to import manually: az keyvault key show --vault-name ${KEY_VAULT_NAME} --name ingestion-cache-cmk --query kid -o tsv"
      fi
    else
      echo "  ✓ module.ingestion_cache.azurerm_key_vault_key.storage-account-byok[0] already in state, skipping"
    fi

    # Import ingestion_cache Key Vault Secrets (requires version ID)
    echo "Checking module.ingestion_cache.azurerm_key_vault_secret.storage-account-connection-string-1[0]..."
    if ! terraform state show 'module.ingestion_cache.azurerm_key_vault_secret.storage-account-connection-string-1[0]' >/dev/null 2>&1; then
      SECRET_ID=$(az keyvault secret list-versions --vault-name "${KEY_VAULT_NAME}" --name "ingestion-cache-connection-string-1" --query "[0].id" -o tsv 2>/dev/null || echo "")
      if [ -n "${SECRET_ID}" ]; then
        echo "  Importing module.ingestion_cache.azurerm_key_vault_secret.storage-account-connection-string-1[0]..."
        terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
          'module.ingestion_cache.azurerm_key_vault_secret.storage-account-connection-string-1[0]' \
          "${SECRET_ID}"
        echo "  ✓ Imported module.ingestion_cache.azurerm_key_vault_secret.storage-account-connection-string-1[0]"
      else
        echo "  ⚠️  Could not determine secret version for ingestion-cache-connection-string-1, skipping import"
        echo "      You may need to import manually: az keyvault secret list-versions --vault-name ${KEY_VAULT_NAME} --name ingestion-cache-connection-string-1 --query '[0].id' -o tsv"
      fi
    else
      echo "  ✓ module.ingestion_cache.azurerm_key_vault_secret.storage-account-connection-string-1[0] already in state, skipping"
    fi

    echo "Checking module.ingestion_cache.azurerm_key_vault_secret.storage-account-connection-string-2[0]..."
    if ! terraform state show 'module.ingestion_cache.azurerm_key_vault_secret.storage-account-connection-string-2[0]' >/dev/null 2>&1; then
      SECRET_ID=$(az keyvault secret list-versions --vault-name "${KEY_VAULT_NAME}" --name "ingestion-cache-connection-string-2" --query "[0].id" -o tsv 2>/dev/null || echo "")
      if [ -n "${SECRET_ID}" ]; then
        echo "  Importing module.ingestion_cache.azurerm_key_vault_secret.storage-account-connection-string-2[0]..."
        terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
          'module.ingestion_cache.azurerm_key_vault_secret.storage-account-connection-string-2[0]' \
          "${SECRET_ID}"
        echo "  ✓ Imported module.ingestion_cache.azurerm_key_vault_secret.storage-account-connection-string-2[0]"
      else
        echo "  ⚠️  Could not determine secret version for ingestion-cache-connection-string-2, skipping import"
        echo "      You may need to import manually: az keyvault secret list-versions --vault-name ${KEY_VAULT_NAME} --name ingestion-cache-connection-string-2 --query '[0].id' -o tsv"
      fi
    else
      echo "  ✓ module.ingestion_cache.azurerm_key_vault_secret.storage-account-connection-string-2[0] already in state, skipping"
    fi

    # Import ingestion_cache Customer Managed Key
    echo "Checking module.ingestion_cache.azurerm_storage_account_customer_managed_key.storage_account_cmk[0]..."
    if ! terraform state show 'module.ingestion_cache.azurerm_storage_account_customer_managed_key.storage_account_cmk[0]' >/dev/null 2>&1; then
      echo "  Importing module.ingestion_cache.azurerm_storage_account_customer_managed_key.storage_account_cmk[0]..."
      terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
        'module.ingestion_cache.azurerm_storage_account_customer_managed_key.storage_account_cmk[0]' \
        "/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP_SENSITIVE}/providers/Microsoft.Storage/storageAccounts/${INGESTION_CACHE_SA_NAME}"
      echo "  ✓ Imported module.ingestion_cache.azurerm_storage_account_customer_managed_key.storage_account_cmk[0]"
    else
      echo "  ✓ module.ingestion_cache.azurerm_storage_account_customer_managed_key.storage_account_cmk[0] already in state, skipping"
    fi

    # Import ingestion_cache Storage Management Policy
    echo "Checking module.ingestion_cache.azurerm_storage_management_policy.default[0]..."
    if ! terraform state show 'module.ingestion_cache.azurerm_storage_management_policy.default[0]' >/dev/null 2>&1; then
      echo "  Importing module.ingestion_cache.azurerm_storage_management_policy.default[0]..."
      terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
        'module.ingestion_cache.azurerm_storage_management_policy.default[0]' \
        "/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP_SENSITIVE}/providers/Microsoft.Storage/storageAccounts/${INGESTION_CACHE_SA_NAME}/managementPolicies/default"
      echo "  ✓ Imported module.ingestion_cache.azurerm_storage_management_policy.default[0]"
    else
      echo "  ✓ module.ingestion_cache.azurerm_storage_management_policy.default[0] already in state, skipping"
    fi

    # Import ingestion_storage storage account
    echo "Checking module.ingestion_storage.azurerm_storage_account.storage_account..."
    if ! terraform state show 'module.ingestion_storage.azurerm_storage_account.storage_account' >/dev/null 2>&1; then
      echo "  Importing module.ingestion_storage.azurerm_storage_account.storage_account..."
      terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
        'module.ingestion_storage.azurerm_storage_account.storage_account' \
        "/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP_SENSITIVE}/providers/Microsoft.Storage/storageAccounts/${INGESTION_STORAGE_SA_NAME}"
      echo "  ✓ Imported module.ingestion_storage.azurerm_storage_account.storage_account"
    else
      echo "  ✓ module.ingestion_storage.azurerm_storage_account.storage_account already in state, skipping"
    fi

    # Import ingestion_storage Key Vault Key
    # Format: https://{vault-name}.vault.azure.net/keys/{key-name}/{version-id}
    echo "Checking module.ingestion_storage.azurerm_key_vault_key.storage-account-byok[0]..."
    if ! terraform state show 'module.ingestion_storage.azurerm_key_vault_key.storage-account-byok[0]' >/dev/null 2>&1; then
      KEY_VERSION=$(az keyvault key list-versions --vault-name "${KEY_VAULT_NAME}" --name "ingestion-storage-cmk" --query "[0].kid" -o tsv 2>/dev/null || echo "")
      if [ -n "${KEY_VERSION}" ]; then
        echo "  Importing module.ingestion_storage.azurerm_key_vault_key.storage-account-byok[0]..."
        terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
          'module.ingestion_storage.azurerm_key_vault_key.storage-account-byok[0]' \
          "${KEY_VERSION}"
        echo "  ✓ Imported module.ingestion_storage.azurerm_key_vault_key.storage-account-byok[0]"
      else
        echo "  ⚠️  Could not determine key version for ingestion-storage-cmk, skipping import"
        echo "      You may need to import manually: az keyvault key show --vault-name ${KEY_VAULT_NAME} --name ingestion-storage-cmk --query kid -o tsv"
      fi
    else
      echo "  ✓ module.ingestion_storage.azurerm_key_vault_key.storage-account-byok[0] already in state, skipping"
    fi

    # Import ingestion_storage Key Vault Secrets
    echo "Checking module.ingestion_storage.azurerm_key_vault_secret.storage-account-connection-string-1[0]..."
    if ! terraform state show 'module.ingestion_storage.azurerm_key_vault_secret.storage-account-connection-string-1[0]' >/dev/null 2>&1; then
      SECRET_ID=$(az keyvault secret list-versions --vault-name "${KEY_VAULT_NAME}" --name "ingestion-storage-connection-string-1" --query "[0].id" -o tsv 2>/dev/null || echo "")
      if [ -n "${SECRET_ID}" ]; then
        echo "  Importing module.ingestion_storage.azurerm_key_vault_secret.storage-account-connection-string-1[0]..."
        terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
          'module.ingestion_storage.azurerm_key_vault_secret.storage-account-connection-string-1[0]' \
          "${SECRET_ID}"
        echo "  ✓ Imported module.ingestion_storage.azurerm_key_vault_secret.storage-account-connection-string-1[0]"
      else
        echo "  ⚠️  Could not determine secret version for ingestion-storage-connection-string-1, skipping import"
        echo "      You may need to import manually: az keyvault secret list-versions --vault-name ${KEY_VAULT_NAME} --name ingestion-storage-connection-string-1 --query '[0].id' -o tsv"
      fi
    else
      echo "  ✓ module.ingestion_storage.azurerm_key_vault_secret.storage-account-connection-string-1[0] already in state, skipping"
    fi

    echo "Checking module.ingestion_storage.azurerm_key_vault_secret.storage-account-connection-string-2[0]..."
    if ! terraform state show 'module.ingestion_storage.azurerm_key_vault_secret.storage-account-connection-string-2[0]' >/dev/null 2>&1; then
      SECRET_ID=$(az keyvault secret list-versions --vault-name "${KEY_VAULT_NAME}" --name "ingestion-storage-connection-string-2" --query "[0].id" -o tsv 2>/dev/null || echo "")
      if [ -n "${SECRET_ID}" ]; then
        echo "  Importing module.ingestion_storage.azurerm_key_vault_secret.storage-account-connection-string-2[0]..."
        terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
          'module.ingestion_storage.azurerm_key_vault_secret.storage-account-connection-string-2[0]' \
          "${SECRET_ID}"
        echo "  ✓ Imported module.ingestion_storage.azurerm_key_vault_secret.storage-account-connection-string-2[0]"
      else
        echo "  ⚠️  Could not determine secret version for ingestion-storage-connection-string-2, skipping import"
        echo "      You may need to import manually: az keyvault secret list-versions --vault-name ${KEY_VAULT_NAME} --name ingestion-storage-connection-string-2 --query '[0].id' -o tsv"
      fi
    else
      echo "  ✓ module.ingestion_storage.azurerm_key_vault_secret.storage-account-connection-string-2[0] already in state, skipping"
    fi

    # Import ingestion_storage Customer Managed Key
    echo "Checking module.ingestion_storage.azurerm_storage_account_customer_managed_key.storage_account_cmk[0]..."
    if ! terraform state show 'module.ingestion_storage.azurerm_storage_account_customer_managed_key.storage_account_cmk[0]' >/dev/null 2>&1; then
      echo "  Importing module.ingestion_storage.azurerm_storage_account_customer_managed_key.storage_account_cmk[0]..."
      terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
        'module.ingestion_storage.azurerm_storage_account_customer_managed_key.storage_account_cmk[0]' \
        "/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP_SENSITIVE}/providers/Microsoft.Storage/storageAccounts/${INGESTION_STORAGE_SA_NAME}"
      echo "  ✓ Imported module.ingestion_storage.azurerm_storage_account_customer_managed_key.storage_account_cmk[0]"
    else
      echo "  ✓ module.ingestion_storage.azurerm_storage_account_customer_managed_key.storage_account_cmk[0] already in state, skipping"
    fi

    # Import ingestion_storage Storage Management Policy
    echo "Checking module.ingestion_storage.azurerm_storage_management_policy.default[0]..."
    if ! terraform state show 'module.ingestion_storage.azurerm_storage_management_policy.default[0]' >/dev/null 2>&1; then
      echo "  Importing module.ingestion_storage.azurerm_storage_management_policy.default[0]..."
      terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
        'module.ingestion_storage.azurerm_storage_management_policy.default[0]' \
        "/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP_SENSITIVE}/providers/Microsoft.Storage/storageAccounts/${INGESTION_STORAGE_SA_NAME}/managementPolicies/default"
      echo "  ✓ Imported module.ingestion_storage.azurerm_storage_management_policy.default[0]"
    else
      echo "  ✓ module.ingestion_storage.azurerm_storage_management_policy.default[0] already in state, skipping"
    fi

    # Import Backup Resources for ingestion_cache
    echo ""
    echo "=========================================="
    echo "Backup Resources - ingestion_cache"
    echo "=========================================="
    echo ""
    
    BACKUP_VAULT_BASE_NAME="storage-backup-vault"
    BACKUP_POLICY_NAME="default-blob-backup-policy"
    BACKUP_INSTANCE_NAME="default-blob-backup-instance"
    
    # Import ingestion_cache Backup Vault
    echo "Checking module.ingestion_cache.azurerm_data_protection_backup_vault.backup_vault[0]..."
    if ! terraform state show 'module.ingestion_cache.azurerm_data_protection_backup_vault.backup_vault[0]' >/dev/null 2>&1; then
      # Try to find backup vault - it might have a random suffix
      BACKUP_VAULT_NAME=$(az dataprotection backup-vault list --resource-group "${RESOURCE_GROUP_SENSITIVE}" --query "[?starts_with(name, '${BACKUP_VAULT_BASE_NAME}')].name" -o tsv 2>/dev/null | head -1 || echo "")
      if [ -z "${BACKUP_VAULT_NAME}" ]; then
        # Try exact name match
        BACKUP_VAULT_NAME="${BACKUP_VAULT_BASE_NAME}"
      fi
      
      BACKUP_VAULT_ID=$(az dataprotection backup-vault show --resource-group "${RESOURCE_GROUP_SENSITIVE}" --vault-name "${BACKUP_VAULT_NAME}" --query id -o tsv 2>/dev/null || echo "")
      if [ -n "${BACKUP_VAULT_ID}" ]; then
        echo "  Found backup vault: ${BACKUP_VAULT_NAME}"
        echo "  Importing module.ingestion_cache.azurerm_data_protection_backup_vault.backup_vault[0]..."
        terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
          'module.ingestion_cache.azurerm_data_protection_backup_vault.backup_vault[0]' \
          "${BACKUP_VAULT_ID}"
        echo "  ✓ Imported module.ingestion_cache.azurerm_data_protection_backup_vault.backup_vault[0]"
      else
        echo "  ⚠️  Backup vault '${BACKUP_VAULT_BASE_NAME}' (or with suffix) not found, skipping backup resource imports"
        echo "      Backup resources may need to be created fresh or imported manually"
      fi
    else
      echo "  ✓ module.ingestion_cache.azurerm_data_protection_backup_vault.backup_vault[0] already in state, skipping"
      BACKUP_VAULT_ID=$(terraform state show 'module.ingestion_cache.azurerm_data_protection_backup_vault.backup_vault[0]' 2>/dev/null | grep "^id " | cut -d'"' -f2 || echo "")
      BACKUP_VAULT_NAME=$(echo "${BACKUP_VAULT_ID}" | sed -E 's|.*/backupVaults/([^/]+).*|\1|' || echo "")
    fi

    if [ -n "${BACKUP_VAULT_ID}" ] && [ -n "${BACKUP_VAULT_NAME}" ]; then
      # Import ingestion_cache Backup Policy
      echo "Checking module.ingestion_cache.azurerm_data_protection_backup_policy_blob_storage.backup_policy[0]..."
      if ! terraform state show 'module.ingestion_cache.azurerm_data_protection_backup_policy_blob_storage.backup_policy[0]' >/dev/null 2>&1; then
        # Try to find the policy by name (it might have a different name)
        BACKUP_POLICY_ID=$(az dataprotection backup-policy list --resource-group "${RESOURCE_GROUP_SENSITIVE}" --vault-name "${BACKUP_VAULT_NAME}" --query "[?name=='${BACKUP_POLICY_NAME}'].id" -o tsv 2>/dev/null | head -1 || echo "")
        if [ -z "${BACKUP_POLICY_ID}" ]; then
          # Fallback to constructed ID
          BACKUP_POLICY_ID="${BACKUP_VAULT_ID}/backupPolicies/${BACKUP_POLICY_NAME}"
        fi
        echo "  Importing module.ingestion_cache.azurerm_data_protection_backup_policy_blob_storage.backup_policy[0]..."
        terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
          'module.ingestion_cache.azurerm_data_protection_backup_policy_blob_storage.backup_policy[0]' \
          "${BACKUP_POLICY_ID}" 2>&1 || echo "  ⚠️  Failed to import backup policy, it may need to be created"
        if terraform state show 'module.ingestion_cache.azurerm_data_protection_backup_policy_blob_storage.backup_policy[0]' >/dev/null 2>&1; then
          echo "  ✓ Imported module.ingestion_cache.azurerm_data_protection_backup_policy_blob_storage.backup_policy[0]"
        fi
      else
        echo "  ✓ module.ingestion_cache.azurerm_data_protection_backup_policy_blob_storage.backup_policy[0] already in state, skipping"
      fi

      # Import ingestion_cache Backup Instance
      echo "Checking module.ingestion_cache.azurerm_data_protection_backup_instance_blob_storage.backup_instance[0]..."
      if ! terraform state show 'module.ingestion_cache.azurerm_data_protection_backup_instance_blob_storage.backup_instance[0]' >/dev/null 2>&1; then
        # Try to find the instance - it might be named differently
        BACKUP_INSTANCE_ID=$(az dataprotection backup-instance list --resource-group "${RESOURCE_GROUP_SENSITIVE}" --vault-name "${BACKUP_VAULT_NAME}" --query "[?contains(name, '${INGESTION_CACHE_SA_NAME}') || name=='${BACKUP_INSTANCE_NAME}'].id" -o tsv 2>/dev/null | head -1 || echo "")
        if [ -z "${BACKUP_INSTANCE_ID}" ]; then
          # Fallback to constructed ID
          BACKUP_INSTANCE_ID="${BACKUP_VAULT_ID}/backupInstances/${BACKUP_INSTANCE_NAME}"
        fi
        echo "  Importing module.ingestion_cache.azurerm_data_protection_backup_instance_blob_storage.backup_instance[0]..."
        terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
          'module.ingestion_cache.azurerm_data_protection_backup_instance_blob_storage.backup_instance[0]' \
          "${BACKUP_INSTANCE_ID}" 2>&1 || echo "  ⚠️  Failed to import backup instance, it may need to be created"
        if terraform state show 'module.ingestion_cache.azurerm_data_protection_backup_instance_blob_storage.backup_instance[0]' >/dev/null 2>&1; then
          echo "  ✓ Imported module.ingestion_cache.azurerm_data_protection_backup_instance_blob_storage.backup_instance[0]"
        fi
      else
        echo "  ✓ module.ingestion_cache.azurerm_data_protection_backup_instance_blob_storage.backup_instance[0] already in state, skipping"
      fi

      # Import ingestion_cache Backup Role Assignment
      echo "Checking module.ingestion_cache.azurerm_role_assignment.backup_vault_storage_access[0]..."
      if ! terraform state show 'module.ingestion_cache.azurerm_role_assignment.backup_vault_storage_access[0]' >/dev/null 2>&1; then
        # Get the principal ID from the backup vault identity
        BACKUP_VAULT_PRINCIPAL_ID=$(az dataprotection backup-vault show --resource-group "${RESOURCE_GROUP_SENSITIVE}" --vault-name "${BACKUP_VAULT_NAME}" --query "identity.principalId" -o tsv 2>/dev/null || echo "")
        if [ -n "${BACKUP_VAULT_PRINCIPAL_ID}" ]; then
          # Find the role assignment ID
          ROLE_ASSIGNMENT_ID=$(az role assignment list --scope "/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP_SENSITIVE}/providers/Microsoft.Storage/storageAccounts/${INGESTION_CACHE_SA_NAME}" --assignee "${BACKUP_VAULT_PRINCIPAL_ID}" --role "Storage Account Backup Contributor" --query "[0].id" -o tsv 2>/dev/null || echo "")
          if [ -n "${ROLE_ASSIGNMENT_ID}" ]; then
            echo "  Importing module.ingestion_cache.azurerm_role_assignment.backup_vault_storage_access[0]..."
            terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
              'module.ingestion_cache.azurerm_role_assignment.backup_vault_storage_access[0]' \
              "${ROLE_ASSIGNMENT_ID}"
            echo "  ✓ Imported module.ingestion_cache.azurerm_role_assignment.backup_vault_storage_access[0]"
          else
            echo "  ⚠️  Could not find role assignment for backup vault, skipping import"
          fi
        else
          echo "  ⚠️  Could not get backup vault principal ID, skipping role assignment import"
        fi
      else
        echo "  ✓ module.ingestion_cache.azurerm_role_assignment.backup_vault_storage_access[0] already in state, skipping"
      fi
    fi

    # Import Backup Resources for ingestion_storage
    echo ""
    echo "=========================================="
    echo "Backup Resources - ingestion_storage"
    echo "=========================================="
    echo ""
    
    # Import ingestion_storage Backup Vault (may be the same vault or different)
    echo "Checking module.ingestion_storage.azurerm_data_protection_backup_vault.backup_vault[0]..."
    if ! terraform state show 'module.ingestion_storage.azurerm_data_protection_backup_vault.backup_vault[0]' >/dev/null 2>&1; then
      # Try to get the backup vault ID (might be the same vault or different)
      if [ -z "${BACKUP_VAULT_ID}" ] || [ -z "${BACKUP_VAULT_NAME}" ]; then
        # Try to find backup vault - it might have a random suffix
        BACKUP_VAULT_NAME_STORAGE=$(az dataprotection backup-vault list --resource-group "${RESOURCE_GROUP_SENSITIVE}" --query "[?starts_with(name, '${BACKUP_VAULT_BASE_NAME}')].name" -o tsv 2>/dev/null | head -1 || echo "")
        if [ -z "${BACKUP_VAULT_NAME_STORAGE}" ]; then
          # Try exact name match
          BACKUP_VAULT_NAME_STORAGE="${BACKUP_VAULT_BASE_NAME}"
        fi
        BACKUP_VAULT_ID=$(az dataprotection backup-vault show --resource-group "${RESOURCE_GROUP_SENSITIVE}" --vault-name "${BACKUP_VAULT_NAME_STORAGE}" --query id -o tsv 2>/dev/null || echo "")
        if [ -n "${BACKUP_VAULT_ID}" ]; then
          BACKUP_VAULT_NAME="${BACKUP_VAULT_NAME_STORAGE}"
        fi
      fi
      if [ -n "${BACKUP_VAULT_ID}" ] && [ -n "${BACKUP_VAULT_NAME}" ]; then
        echo "  Found backup vault: ${BACKUP_VAULT_NAME}"
        echo "  Importing module.ingestion_storage.azurerm_data_protection_backup_vault.backup_vault[0]..."
        terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
          'module.ingestion_storage.azurerm_data_protection_backup_vault.backup_vault[0]' \
          "${BACKUP_VAULT_ID}"
        echo "  ✓ Imported module.ingestion_storage.azurerm_data_protection_backup_vault.backup_vault[0]"
      else
        echo "  ⚠️  Backup vault '${BACKUP_VAULT_BASE_NAME}' (or with suffix) not found, skipping backup resource imports"
      fi
    else
      echo "  ✓ module.ingestion_storage.azurerm_data_protection_backup_vault.backup_vault[0] already in state, skipping"
      if [ -z "${BACKUP_VAULT_ID}" ]; then
        BACKUP_VAULT_ID=$(terraform state show 'module.ingestion_storage.azurerm_data_protection_backup_vault.backup_vault[0]' 2>/dev/null | grep "^id " | cut -d'"' -f2 || echo "")
        BACKUP_VAULT_NAME=$(echo "${BACKUP_VAULT_ID}" | sed -E 's|.*/backupVaults/([^/]+).*|\1|' || echo "")
      fi
    fi

    if [ -n "${BACKUP_VAULT_ID}" ] && [ -n "${BACKUP_VAULT_NAME}" ]; then
      # Import ingestion_storage Backup Policy
      echo "Checking module.ingestion_storage.azurerm_data_protection_backup_policy_blob_storage.backup_policy[0]..."
      if ! terraform state show 'module.ingestion_storage.azurerm_data_protection_backup_policy_blob_storage.backup_policy[0]' >/dev/null 2>&1; then
        # Try to find the policy by name (it might have a different name)
        BACKUP_POLICY_ID=$(az dataprotection backup-policy list --resource-group "${RESOURCE_GROUP_SENSITIVE}" --vault-name "${BACKUP_VAULT_NAME}" --query "[?name=='${BACKUP_POLICY_NAME}'].id" -o tsv 2>/dev/null | head -1 || echo "")
        if [ -z "${BACKUP_POLICY_ID}" ]; then
          # Fallback to constructed ID
          BACKUP_POLICY_ID="${BACKUP_VAULT_ID}/backupPolicies/${BACKUP_POLICY_NAME}"
        fi
        echo "  Importing module.ingestion_storage.azurerm_data_protection_backup_policy_blob_storage.backup_policy[0]..."
        terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
          'module.ingestion_storage.azurerm_data_protection_backup_policy_blob_storage.backup_policy[0]' \
          "${BACKUP_POLICY_ID}" 2>&1 || echo "  ⚠️  Failed to import backup policy, it may need to be created"
        if terraform state show 'module.ingestion_storage.azurerm_data_protection_backup_policy_blob_storage.backup_policy[0]' >/dev/null 2>&1; then
          echo "  ✓ Imported module.ingestion_storage.azurerm_data_protection_backup_policy_blob_storage.backup_policy[0]"
        fi
      else
        echo "  ✓ module.ingestion_storage.azurerm_data_protection_backup_policy_blob_storage.backup_policy[0] already in state, skipping"
      fi

      # Import ingestion_storage Backup Instance
      echo "Checking module.ingestion_storage.azurerm_data_protection_backup_instance_blob_storage.backup_instance[0]..."
      if ! terraform state show 'module.ingestion_storage.azurerm_data_protection_backup_instance_blob_storage.backup_instance[0]' >/dev/null 2>&1; then
        # Try to find the instance - it might be named differently
        BACKUP_INSTANCE_ID=$(az dataprotection backup-instance list --resource-group "${RESOURCE_GROUP_SENSITIVE}" --vault-name "${BACKUP_VAULT_NAME}" --query "[?contains(name, '${INGESTION_STORAGE_SA_NAME}') || name=='${BACKUP_INSTANCE_NAME}'].id" -o tsv 2>/dev/null | head -1 || echo "")
        if [ -z "${BACKUP_INSTANCE_ID}" ]; then
          # Fallback to constructed ID
          BACKUP_INSTANCE_ID="${BACKUP_VAULT_ID}/backupInstances/${BACKUP_INSTANCE_NAME}"
        fi
        echo "  Importing module.ingestion_storage.azurerm_data_protection_backup_instance_blob_storage.backup_instance[0]..."
        terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
          'module.ingestion_storage.azurerm_data_protection_backup_instance_blob_storage.backup_instance[0]' \
          "${BACKUP_INSTANCE_ID}" 2>&1 || echo "  ⚠️  Failed to import backup instance, it may need to be created"
        if terraform state show 'module.ingestion_storage.azurerm_data_protection_backup_instance_blob_storage.backup_instance[0]' >/dev/null 2>&1; then
          echo "  ✓ Imported module.ingestion_storage.azurerm_data_protection_backup_instance_blob_storage.backup_instance[0]"
        fi
      else
        echo "  ✓ module.ingestion_storage.azurerm_data_protection_backup_instance_blob_storage.backup_instance[0] already in state, skipping"
      fi

      # Import ingestion_storage Backup Role Assignment
      echo "Checking module.ingestion_storage.azurerm_role_assignment.backup_vault_storage_access[0]..."
      if ! terraform state show 'module.ingestion_storage.azurerm_role_assignment.backup_vault_storage_access[0]' >/dev/null 2>&1; then
        # Get the principal ID from the backup vault identity
        if [ -z "${BACKUP_VAULT_PRINCIPAL_ID}" ]; then
          BACKUP_VAULT_PRINCIPAL_ID=$(az dataprotection backup-vault show --resource-group "${RESOURCE_GROUP_SENSITIVE}" --vault-name "${BACKUP_VAULT_NAME}" --query "identity.principalId" -o tsv 2>/dev/null || echo "")
        fi
        if [ -n "${BACKUP_VAULT_PRINCIPAL_ID}" ]; then
          # Find the role assignment ID
          ROLE_ASSIGNMENT_ID=$(az role assignment list --scope "/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP_SENSITIVE}/providers/Microsoft.Storage/storageAccounts/${INGESTION_STORAGE_SA_NAME}" --assignee "${BACKUP_VAULT_PRINCIPAL_ID}" --role "Storage Account Backup Contributor" --query "[0].id" -o tsv 2>/dev/null || echo "")
          if [ -n "${ROLE_ASSIGNMENT_ID}" ]; then
            echo "  Importing module.ingestion_storage.azurerm_role_assignment.backup_vault_storage_access[0]..."
            terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
              'module.ingestion_storage.azurerm_role_assignment.backup_vault_storage_access[0]' \
              "${ROLE_ASSIGNMENT_ID}"
            echo "  ✓ Imported module.ingestion_storage.azurerm_role_assignment.backup_vault_storage_access[0]"
          else
            echo "  ⚠️  Could not find role assignment for backup vault, skipping import"
          fi
        else
          echo "  ⚠️  Could not get backup vault principal ID, skipping role assignment import"
        fi
      else
        echo "  ✓ module.ingestion_storage.azurerm_role_assignment.backup_vault_storage_access[0] already in state, skipping"
      fi
    fi
  fi
fi

echo ""
echo "=========================================="
echo "Importing Role Assignments"
echo "=========================================="
echo ""

# Subscription ID - get from config or set here
SUBSCRIPTION_ID="${SUBSCRIPTION_ID:-782871a0-bcee-44fb-851f-ccd3e69ada2a}"

# Resource Group Names
RESOURCE_GROUP_CORE_NAME="resource-group-core"

# Resource IDs (constructed from subscription and resource names)
RESOURCE_GROUP_CORE_ID="/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP_CORE_NAME}"
KEY_VAULT_MAIN_ID="/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/resource-group-core/providers/Microsoft.KeyVault/vaults/hakv1${ENV}v2"
KEY_VAULT_SENSITIVE_ID="/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/resource-group-sensitive/providers/Microsoft.KeyVault/vaults/hakv2${ENV}v2"

# Get role definition IDs using Azure CLI
echo "Getting role definition IDs..."
echo "  Note: Role definition IDs must be in full format: /subscriptions/{sub-id}/providers/Microsoft.Authorization/roleDefinitions/{guid}"
echo ""

# Standard built-in roles (scope can be subscription or management group)
ROLE_KV_SECRETS_USER_ID=$(az role definition list --name "Key Vault Secrets User" --query '[0].id' -o tsv 2>/dev/null | head -1 || echo "")
ROLE_KV_CRYPTO_USER_ID=$(az role definition list --name "Key Vault Crypto Service Encryption User" --query '[0].id' -o tsv 2>/dev/null | head -1 || echo "")
ROLE_KV_SECRETS_OFFICER_ID=$(az role definition list --name "Key Vault Secrets Officer" --query '[0].id' -o tsv 2>/dev/null | head -1 || echo "")
ROLE_KV_CRYPTO_OFFICER_ID=$(az role definition list --name "Key Vault Crypto Officer" --query '[0].id' -o tsv 2>/dev/null | head -1 || echo "")
ROLE_KV_DATA_ACCESS_ADMIN_ID=$(az role definition list --name "Key Vault Data Access Administrator" --query '[0].id' -o tsv 2>/dev/null | head -1 || echo "")
ROLE_COGNITIVE_SERVICES_USER_ID=$(az role definition list --name "Cognitive Services User" --query '[0].id' -o tsv 2>/dev/null | head -1 || echo "")
ROLE_MONITORING_DATA_READER_ID=$(az role definition list --name "Monitoring Data Reader" --query '[0].id' -o tsv 2>/dev/null | head -1 || echo "")
ROLE_ACRPUSH_ID=$(az role definition list --name "AcrPush" --query '[0].id' -o tsv 2>/dev/null | head -1 || echo "")
ROLE_DNS_ZONE_CONTRIBUTOR_ID=$(az role definition list --name "DNS Zone Contributor" --query '[0].id' -o tsv 2>/dev/null | head -1 || echo "")
ROLE_AKS_CONTRIBUTOR_ID=$(az role definition list --name "Azure Kubernetes Service Contributor Role" --query '[0].id' -o tsv 2>/dev/null | head -1 || echo "")
ROLE_AKS_RBAC_ADMIN_ID=$(az role definition list --name "Azure Kubernetes Service RBAC Cluster Admin" --query '[0].id' -o tsv 2>/dev/null | head -1 || echo "")
ROLE_CONTRIBUTOR_ID=$(az role definition list --name "Contributor" --query '[0].id' -o tsv 2>/dev/null | head -1 || echo "")
ROLE_READER_ID=$(az role definition list --name "Reader" --query '[0].id' -o tsv 2>/dev/null | head -1 || echo "")

# Get custom role definition IDs (these are subscription-scoped)
# Format: /subscriptions/{subscription-id}/providers/Microsoft.Authorization/roleDefinitions/{guid}
# These need to be retrieved from existing state or Azure
echo "Getting custom role definition IDs (subscription-scoped)..."
TELEMETRY_OBSERVER_ROLE_ID=$(az role definition list --name "Telemetry Observer${ENV:+-${ENV}}" --scope "/subscriptions/${SUBSCRIPTION_ID}" --query '[0].id' -o tsv 2>/dev/null | head -1 || echo "")

# Validate that role definition IDs are in the correct format
validate_role_id() {
  local role_id="$1"
  local role_name="$2"
  if [[ -z "${role_id}" ]]; then
    echo "  ⚠️  Warning: Could not retrieve role definition ID for '${role_name}'"
    return 1
  fi
  if [[ ! "${role_id}" =~ ^/subscriptions/.*/providers/Microsoft.Authorization/roleDefinitions/ ]]; then
    echo "  ⚠️  Warning: Role definition ID for '${role_name}' has unexpected format: ${role_id}"
    return 1
  fi
  return 0
}

# Validate critical role definition IDs
echo "Validating role definition IDs..."
MISSING_ROLES=()
validate_role_id "${ROLE_KV_SECRETS_USER_ID}" "Key Vault Secrets User" || MISSING_ROLES+=("Key Vault Secrets User")
validate_role_id "${ROLE_KV_CRYPTO_USER_ID}" "Key Vault Crypto Service Encryption User" || MISSING_ROLES+=("Key Vault Crypto Service Encryption User")
validate_role_id "${ROLE_KV_SECRETS_OFFICER_ID}" "Key Vault Secrets Officer" || MISSING_ROLES+=("Key Vault Secrets Officer")
validate_role_id "${ROLE_COGNITIVE_SERVICES_USER_ID}" "Cognitive Services User" || MISSING_ROLES+=("Cognitive Services User")
validate_role_id "${ROLE_MONITORING_DATA_READER_ID}" "Monitoring Data Reader" || MISSING_ROLES+=("Monitoring Data Reader")
validate_role_id "${ROLE_ACRPUSH_ID}" "AcrPush" || MISSING_ROLES+=("AcrPush")
validate_role_id "${ROLE_DNS_ZONE_CONTRIBUTOR_ID}" "DNS Zone Contributor" || MISSING_ROLES+=("DNS Zone Contributor")
validate_role_id "${ROLE_AKS_CONTRIBUTOR_ID}" "Azure Kubernetes Service Contributor Role" || MISSING_ROLES+=("Azure Kubernetes Service Contributor Role")
validate_role_id "${ROLE_AKS_RBAC_ADMIN_ID}" "Azure Kubernetes Service RBAC Cluster Admin" || MISSING_ROLES+=("Azure Kubernetes Service RBAC Cluster Admin")
validate_role_id "${ROLE_CONTRIBUTOR_ID}" "Contributor" || MISSING_ROLES+=("Contributor")
validate_role_id "${ROLE_READER_ID}" "Reader" || MISSING_ROLES+=("Reader")

if [[ ${#MISSING_ROLES[@]} -gt 0 ]]; then
echo ""
  echo "⚠️  Warning: Could not retrieve or validate some role definition IDs:"
  printf "   - %s\n" "${MISSING_ROLES[@]}"
  echo "   You may need to run: az login"
  echo "   Or set them manually in the script."
echo ""
fi
echo ""

# Managed Identity Principal IDs (from terraform plan output)
INGESTION_CACHE_IDENTITY_PRINCIPAL_ID="02fbfd8a-96a4-4273-9c44-a2fc188d2932"
INGESTION_STORAGE_IDENTITY_PRINCIPAL_ID="63b372e5-7003-4f61-a5c1-8fbbc95d9ddf"
PSQL_IDENTITY_PRINCIPAL_ID="a4d837a4-7e7f-4639-9619-30ba7fa95562"
GRAFANA_IDENTITY_PRINCIPAL_ID="48283dc1-2cb1-4b0d-a170-7a2c11de3e03"

# User Principal IDs
USER_084A1C45="084a1c45-5010-4aab-bab6-7b86a9d10e5c"
USER_3B48F167="3b48f167-cb68-4655-b45b-878e170af84d"
USER_4B89A1F0="4b89a1f0-8038-4929-81e6-6d128dac7aa0"
USER_4EE4611F="4ee4611f-b24c-444b-8d34-edab333bf868"

# Group Principal IDs
MAIN_KEYVAULT_SECRET_WRITER_GROUP_ID="fa8f2e2c-154e-4d4a-a99c-7dfa825858ef"
TELEMETRY_OBSERVER_GROUP_ID="3e60cd87-c622-44d7-801f-fc691822d0ca"

# Terraform Service Principal
TERRAFORM_SP_PRINCIPAL_ID="dde525a7-fbfa-4a7c-88da-b9bcaf75830f"

# Ingestion Cache Identity - Key Vault assignments
echo ""
if ! terraform state show azurerm_role_assignment.ingestion_cache_kv_key_reader >/dev/null 2>&1; then
  if [[ -n "${ROLE_KV_CRYPTO_USER_ID}" ]] && [[ -n "${INGESTION_CACHE_IDENTITY_PRINCIPAL_ID}" ]]; then
    ROLE_ASSIGNMENT_ID=$(az role assignment list \
      --scope "${KEY_VAULT_SENSITIVE_ID}" \
      --assignee "${INGESTION_CACHE_IDENTITY_PRINCIPAL_ID}" \
      --role "Key Vault Crypto Service Encryption User" \
      --query "[0].id" -o tsv 2>/dev/null || echo "")
    
    if [[ -n "${ROLE_ASSIGNMENT_ID}" ]]; then
      echo "  Importing azurerm_role_assignment.ingestion_cache_kv_key_reader..."
      terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
        azurerm_role_assignment.ingestion_cache_kv_key_reader \
        "${ROLE_ASSIGNMENT_ID}" 2>&1 | grep -v "^\[0m" || true
      if terraform state show azurerm_role_assignment.ingestion_cache_kv_key_reader >/dev/null 2>&1; then
        echo "  ✓ Imported azurerm_role_assignment.ingestion_cache_kv_key_reader"
      else
        echo "  ✗ FAILED to import azurerm_role_assignment.ingestion_cache_kv_key_reader"
        exit 1
      fi
    else
      echo "  ⚠️  Could not retrieve role assignment ID from Azure"
      echo "  Importing azurerm_role_assignment.ingestion_cache_kv_key_reader..."
      terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
        azurerm_role_assignment.ingestion_cache_kv_key_reader \
        "${KEY_VAULT_SENSITIVE_ID}|${INGESTION_CACHE_IDENTITY_PRINCIPAL_ID}|${ROLE_KV_CRYPTO_USER_ID}" 2>&1 | grep -v "^\[0m" || true
      if terraform state show azurerm_role_assignment.ingestion_cache_kv_key_reader >/dev/null 2>&1; then
        echo "  ✓ Imported azurerm_role_assignment.ingestion_cache_kv_key_reader"
      else
        echo "  ✗ FAILED to import azurerm_role_assignment.ingestion_cache_kv_key_reader"
        exit 1
      fi
    fi
  else
    echo "  ⚠️  Skipping - role definition ID or principal ID not available"
  fi
else
  echo "  ✓ azurerm_role_assignment.ingestion_cache_kv_key_reader already in state, skipping"
fi

echo ""
if ! terraform state show azurerm_role_assignment.ingestion_cache_kv_secrets_reader >/dev/null 2>&1; then
  if [[ -n "${ROLE_KV_SECRETS_USER_ID}" ]] && [[ -n "${INGESTION_CACHE_IDENTITY_PRINCIPAL_ID}" ]]; then
    ROLE_ASSIGNMENT_ID=$(az role assignment list \
      --scope "${KEY_VAULT_SENSITIVE_ID}" \
      --assignee "${INGESTION_CACHE_IDENTITY_PRINCIPAL_ID}" \
      --role "Key Vault Secrets User" \
      --query "[0].id" -o tsv 2>/dev/null || echo "")
    
    if [[ -n "${ROLE_ASSIGNMENT_ID}" ]]; then
      echo "  Importing azurerm_role_assignment.ingestion_cache_kv_secrets_reader..."
      terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
        azurerm_role_assignment.ingestion_cache_kv_secrets_reader \
        "${ROLE_ASSIGNMENT_ID}" 2>&1 | grep -v "^\[0m" || true
      if terraform state show azurerm_role_assignment.ingestion_cache_kv_secrets_reader >/dev/null 2>&1; then
        echo "  ✓ Imported azurerm_role_assignment.ingestion_cache_kv_secrets_reader"
      else
        echo "  ✗ FAILED to import azurerm_role_assignment.ingestion_cache_kv_secrets_reader"
        exit 1
      fi
    else
      echo "  ⚠️  Could not retrieve role assignment ID from Azure"
      echo "  Importing azurerm_role_assignment.ingestion_cache_kv_secrets_reader..."
      terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
        azurerm_role_assignment.ingestion_cache_kv_secrets_reader \
        "${KEY_VAULT_SENSITIVE_ID}|${INGESTION_CACHE_IDENTITY_PRINCIPAL_ID}|${ROLE_KV_SECRETS_USER_ID}" 2>&1 | grep -v "^\[0m" || true
      if terraform state show azurerm_role_assignment.ingestion_cache_kv_secrets_reader >/dev/null 2>&1; then
        echo "  ✓ Imported azurerm_role_assignment.ingestion_cache_kv_secrets_reader"
      else
        echo "  ✗ FAILED to import azurerm_role_assignment.ingestion_cache_kv_secrets_reader"
        exit 1
      fi
    fi
  else
    echo "  ⚠️  Skipping - role definition ID or principal ID not available"
  fi
else
  echo "  ✓ azurerm_role_assignment.ingestion_cache_kv_secrets_reader already in state, skipping"
fi

# Ingestion Storage Identity - Key Vault assignments
echo ""
if ! terraform state show azurerm_role_assignment.ingestion_storage_kv_key_reader >/dev/null 2>&1; then
  if [[ -n "${ROLE_KV_CRYPTO_USER_ID}" ]] && [[ -n "${INGESTION_STORAGE_IDENTITY_PRINCIPAL_ID}" ]]; then
    ROLE_ASSIGNMENT_ID=$(az role assignment list \
      --scope "${KEY_VAULT_SENSITIVE_ID}" \
      --assignee "${INGESTION_STORAGE_IDENTITY_PRINCIPAL_ID}" \
      --role "Key Vault Crypto Service Encryption User" \
      --query "[0].id" -o tsv 2>/dev/null || echo "")
    
    if [[ -n "${ROLE_ASSIGNMENT_ID}" ]]; then
      echo "  Importing azurerm_role_assignment.ingestion_storage_kv_key_reader..."
      terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
        azurerm_role_assignment.ingestion_storage_kv_key_reader \
        "${ROLE_ASSIGNMENT_ID}" 2>&1 | grep -v "^\[0m" || true
      if terraform state show azurerm_role_assignment.ingestion_storage_kv_key_reader >/dev/null 2>&1; then
        echo "  ✓ Imported azurerm_role_assignment.ingestion_storage_kv_key_reader"
      else
        echo "  ✗ FAILED to import azurerm_role_assignment.ingestion_storage_kv_key_reader"
        exit 1
      fi
    else
      echo "  ⚠️  Could not retrieve role assignment ID from Azure"
      echo "  Importing azurerm_role_assignment.ingestion_storage_kv_key_reader..."
      terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
        azurerm_role_assignment.ingestion_storage_kv_key_reader \
        "${KEY_VAULT_SENSITIVE_ID}|${INGESTION_STORAGE_IDENTITY_PRINCIPAL_ID}|${ROLE_KV_CRYPTO_USER_ID}" 2>&1 | grep -v "^\[0m" || true
      if terraform state show azurerm_role_assignment.ingestion_storage_kv_key_reader >/dev/null 2>&1; then
        echo "  ✓ Imported azurerm_role_assignment.ingestion_storage_kv_key_reader"
      else
        echo "  ✗ FAILED to import azurerm_role_assignment.ingestion_storage_kv_key_reader"
        exit 1
      fi
    fi
  else
    echo "  ⚠️  Skipping - role definition ID or principal ID not available"
  fi
else
  echo "  ✓ azurerm_role_assignment.ingestion_storage_kv_key_reader already in state, skipping"
fi

echo ""
if ! terraform state show azurerm_role_assignment.ingestion_storage_kv_secrets_reader >/dev/null 2>&1; then
  if [[ -n "${ROLE_KV_SECRETS_USER_ID}" ]] && [[ -n "${INGESTION_STORAGE_IDENTITY_PRINCIPAL_ID}" ]]; then
    ROLE_ASSIGNMENT_ID=$(az role assignment list \
      --scope "${KEY_VAULT_SENSITIVE_ID}" \
      --assignee "${INGESTION_STORAGE_IDENTITY_PRINCIPAL_ID}" \
      --role "Key Vault Secrets User" \
      --query "[0].id" -o tsv 2>/dev/null || echo "")
    
    if [[ -n "${ROLE_ASSIGNMENT_ID}" ]]; then
      echo "  Importing azurerm_role_assignment.ingestion_storage_kv_secrets_reader..."
      terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
        azurerm_role_assignment.ingestion_storage_kv_secrets_reader \
        "${ROLE_ASSIGNMENT_ID}" 2>&1 | grep -v "^\[0m" || true
      if terraform state show azurerm_role_assignment.ingestion_storage_kv_secrets_reader >/dev/null 2>&1; then
        echo "  ✓ Imported azurerm_role_assignment.ingestion_storage_kv_secrets_reader"
      else
        echo "  ✗ FAILED to import azurerm_role_assignment.ingestion_storage_kv_secrets_reader"
        exit 1
      fi
    else
      echo "  ⚠️  Could not retrieve role assignment ID from Azure"
      echo "  Importing azurerm_role_assignment.ingestion_storage_kv_secrets_reader..."
      terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
        azurerm_role_assignment.ingestion_storage_kv_secrets_reader \
        "${KEY_VAULT_SENSITIVE_ID}|${INGESTION_STORAGE_IDENTITY_PRINCIPAL_ID}|${ROLE_KV_SECRETS_USER_ID}" 2>&1 | grep -v "^\[0m" || true
      if terraform state show azurerm_role_assignment.ingestion_storage_kv_secrets_reader >/dev/null 2>&1; then
        echo "  ✓ Imported azurerm_role_assignment.ingestion_storage_kv_secrets_reader"
      else
        echo "  ✗ FAILED to import azurerm_role_assignment.ingestion_storage_kv_secrets_reader"
        exit 1
      fi
    fi
  else
    echo "  ⚠️  Skipping - role definition ID or principal ID not available"
  fi
else
  echo "  ✓ azurerm_role_assignment.ingestion_storage_kv_secrets_reader already in state, skipping"
fi

# PostgreSQL Identity - Key Vault Key Reader
echo ""
if ! terraform state show azurerm_role_assignment.psql_identity_role_assignment >/dev/null 2>&1; then
  if [[ -n "${ROLE_KV_CRYPTO_USER_ID}" ]] && [[ -n "${PSQL_IDENTITY_PRINCIPAL_ID}" ]]; then
    ROLE_ASSIGNMENT_ID=$(az role assignment list \
      --scope "${KEY_VAULT_SENSITIVE_ID}" \
      --assignee "${PSQL_IDENTITY_PRINCIPAL_ID}" \
      --role "Key Vault Crypto Service Encryption User" \
      --query "[0].id" -o tsv 2>/dev/null || echo "")
    
    if [[ -n "${ROLE_ASSIGNMENT_ID}" ]]; then
      echo "  Importing azurerm_role_assignment.psql_identity_role_assignment..."
      terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
        azurerm_role_assignment.psql_identity_role_assignment \
        "${ROLE_ASSIGNMENT_ID}" 2>&1 | grep -v "^\[0m" || true
      if terraform state show azurerm_role_assignment.psql_identity_role_assignment >/dev/null 2>&1; then
        echo "  ✓ Imported azurerm_role_assignment.psql_identity_role_assignment"
      else
        echo "  ✗ FAILED to import azurerm_role_assignment.psql_identity_role_assignment"
        exit 1
      fi
    else
      echo "  ⚠️  Could not retrieve role assignment ID from Azure"
      echo "  Importing azurerm_role_assignment.psql_identity_role_assignment..."
      terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
        azurerm_role_assignment.psql_identity_role_assignment \
        "${KEY_VAULT_SENSITIVE_ID}|${PSQL_IDENTITY_PRINCIPAL_ID}|${ROLE_KV_CRYPTO_USER_ID}" 2>&1 | grep -v "^\[0m" || true
      if terraform state show azurerm_role_assignment.psql_identity_role_assignment >/dev/null 2>&1; then
        echo "  ✓ Imported azurerm_role_assignment.psql_identity_role_assignment"
      else
        echo "  ✗ FAILED to import azurerm_role_assignment.psql_identity_role_assignment"
        exit 1
      fi
    fi
  else
    echo "  ⚠️  Skipping - role definition ID or principal ID not available"
  fi
else
  echo "  ✓ azurerm_role_assignment.psql_identity_role_assignment already in state, skipping"
fi

# Main Key Vault - Key Reader Users
for USER_ID in "${USER_084A1C45}" "${USER_3B48F167}" "${USER_4B89A1F0}" "${USER_4EE4611F}"; do
  echo ""
  if ! terraform state show "azurerm_role_assignment.main_keyvault_key_reader_users[\"${USER_ID}\"]" >/dev/null 2>&1; then
    if [[ -n "${ROLE_KV_CRYPTO_USER_ID}" ]] && [[ -n "${USER_ID}" ]]; then
      ROLE_ASSIGNMENT_ID=$(az role assignment list \
        --scope "${KEY_VAULT_MAIN_ID}" \
        --assignee "${USER_ID}" \
        --role "Key Vault Crypto Service Encryption User" \
        --query "[0].id" -o tsv 2>/dev/null || echo "")
      
      if [[ -n "${ROLE_ASSIGNMENT_ID}" ]]; then
        echo "  Importing azurerm_role_assignment.main_keyvault_key_reader_users[\"${USER_ID}\"]..."
        terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
          "azurerm_role_assignment.main_keyvault_key_reader_users[\"${USER_ID}\"]" \
          "${ROLE_ASSIGNMENT_ID}" 2>&1 | grep -v "^\[0m" || true
        if terraform state show "azurerm_role_assignment.main_keyvault_key_reader_users[\"${USER_ID}\"]" >/dev/null 2>&1; then
          echo "  ✓ Imported azurerm_role_assignment.main_keyvault_key_reader_users[\"${USER_ID}\"]"
        else
          echo "  ✗ FAILED to import azurerm_role_assignment.main_keyvault_key_reader_users[\"${USER_ID}\"]"
          exit 1
        fi
      else
        echo "  ⚠️  Could not retrieve role assignment ID from Azure"
        echo "  Importing azurerm_role_assignment.main_keyvault_key_reader_users[\"${USER_ID}\"]..."
        terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
          "azurerm_role_assignment.main_keyvault_key_reader_users[\"${USER_ID}\"]" \
          "${KEY_VAULT_MAIN_ID}|${USER_ID}|${ROLE_KV_CRYPTO_USER_ID}" 2>&1 | grep -v "^\[0m" || true
        if terraform state show "azurerm_role_assignment.main_keyvault_key_reader_users[\"${USER_ID}\"]" >/dev/null 2>&1; then
          echo "  ✓ Imported azurerm_role_assignment.main_keyvault_key_reader_users[\"${USER_ID}\"]"
        else
          echo "  ✗ FAILED to import azurerm_role_assignment.main_keyvault_key_reader_users[\"${USER_ID}\"]"
          exit 1
        fi
      fi
    else
      echo "  ⚠️  Skipping - role definition ID or user ID not available"
    fi
  else
    echo "  ✓ azurerm_role_assignment.main_keyvault_key_reader_users[\"${USER_ID}\"] already in state, skipping"
  fi
done

# Main Key Vault - Secret Manager Group
echo ""
if ! terraform state show azurerm_role_assignment.main_keyvault_secret_manager_group >/dev/null 2>&1; then
  if [[ -n "${ROLE_KV_SECRETS_OFFICER_ID}" ]] && [[ -n "${MAIN_KEYVAULT_SECRET_WRITER_GROUP_ID}" ]]; then
    ROLE_ASSIGNMENT_ID=$(az role assignment list \
      --scope "${KEY_VAULT_MAIN_ID}" \
      --assignee "${MAIN_KEYVAULT_SECRET_WRITER_GROUP_ID}" \
      --role "Key Vault Secrets Officer" \
      --query "[0].id" -o tsv 2>/dev/null || echo "")
    
    if [[ -n "${ROLE_ASSIGNMENT_ID}" ]]; then
      echo "  Importing azurerm_role_assignment.main_keyvault_secret_manager_group..."
      terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
        azurerm_role_assignment.main_keyvault_secret_manager_group \
        "${ROLE_ASSIGNMENT_ID}" 2>&1 | grep -v "^\[0m" || true
      if terraform state show azurerm_role_assignment.main_keyvault_secret_manager_group >/dev/null 2>&1; then
        echo "  ✓ Imported azurerm_role_assignment.main_keyvault_secret_manager_group"
      else
        echo "  ✗ FAILED to import azurerm_role_assignment.main_keyvault_secret_manager_group"
        exit 1
      fi
    else
      echo "  ⚠️  Could not retrieve role assignment ID from Azure"
      echo "  Importing azurerm_role_assignment.main_keyvault_secret_manager_group..."
      terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
        azurerm_role_assignment.main_keyvault_secret_manager_group \
        "${KEY_VAULT_MAIN_ID}|${MAIN_KEYVAULT_SECRET_WRITER_GROUP_ID}|${ROLE_KV_SECRETS_OFFICER_ID}" 2>&1 | grep -v "^\[0m" || true
      if terraform state show azurerm_role_assignment.main_keyvault_secret_manager_group >/dev/null 2>&1; then
        echo "  ✓ Imported azurerm_role_assignment.main_keyvault_secret_manager_group"
      else
        echo "  ✗ FAILED to import azurerm_role_assignment.main_keyvault_secret_manager_group"
        exit 1
      fi
    fi
  else
    echo "  ⚠️  Skipping - role definition ID or group ID not available"
  fi
else
  echo "  ✓ azurerm_role_assignment.main_keyvault_secret_manager_group already in state, skipping"
fi

# Main Key Vault - Secret Manager Users
for USER_ID in "${USER_084A1C45}" "${USER_3B48F167}" "${USER_4B89A1F0}" "${USER_4EE4611F}"; do
  echo ""
  if ! terraform state show "azurerm_role_assignment.main_keyvault_secret_manager_users[\"${USER_ID}\"]" >/dev/null 2>&1; then
    if [[ -n "${ROLE_KV_SECRETS_OFFICER_ID}" ]] && [[ -n "${USER_ID}" ]]; then
      ROLE_ASSIGNMENT_ID=$(az role assignment list \
        --scope "${KEY_VAULT_MAIN_ID}" \
        --assignee "${USER_ID}" \
        --role "Key Vault Secrets Officer" \
        --query "[0].id" -o tsv 2>/dev/null || echo "")
      
      if [[ -n "${ROLE_ASSIGNMENT_ID}" ]]; then
        echo "  Importing azurerm_role_assignment.main_keyvault_secret_manager_users[\"${USER_ID}\"]..."
        terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
          "azurerm_role_assignment.main_keyvault_secret_manager_users[\"${USER_ID}\"]" \
          "${ROLE_ASSIGNMENT_ID}" 2>&1 | grep -v "^\[0m" || true
        if terraform state show "azurerm_role_assignment.main_keyvault_secret_manager_users[\"${USER_ID}\"]" >/dev/null 2>&1; then
          echo "  ✓ Imported azurerm_role_assignment.main_keyvault_secret_manager_users[\"${USER_ID}\"]"
        else
          echo "  ✗ FAILED to import azurerm_role_assignment.main_keyvault_secret_manager_users[\"${USER_ID}\"]"
          exit 1
        fi
      else
        echo "  ⚠️  Could not retrieve role assignment ID from Azure"
        echo "  Importing azurerm_role_assignment.main_keyvault_secret_manager_users[\"${USER_ID}\"]..."
        terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
          "azurerm_role_assignment.main_keyvault_secret_manager_users[\"${USER_ID}\"]" \
          "${KEY_VAULT_MAIN_ID}|${USER_ID}|${ROLE_KV_SECRETS_OFFICER_ID}" 2>&1 | grep -v "^\[0m" || true
        if terraform state show "azurerm_role_assignment.main_keyvault_secret_manager_users[\"${USER_ID}\"]" >/dev/null 2>&1; then
          echo "  ✓ Imported azurerm_role_assignment.main_keyvault_secret_manager_users[\"${USER_ID}\"]"
        else
          echo "  ✗ FAILED to import azurerm_role_assignment.main_keyvault_secret_manager_users[\"${USER_ID}\"]"
          exit 1
        fi
      fi
    else
      echo "  ⚠️  Skipping - role definition ID or user ID not available"
    fi
  else
    echo "  ✓ azurerm_role_assignment.main_keyvault_secret_manager_users[\"${USER_ID}\"] already in state, skipping"
  fi
done

# Grafana Identity - Monitoring Data Reader
echo ""
if ! terraform state show azurerm_role_assignment.monitor_metrics_reader >/dev/null 2>&1; then
  if [[ -n "${ROLE_MONITORING_DATA_READER_ID}" ]] && [[ -n "${GRAFANA_IDENTITY_PRINCIPAL_ID}" ]]; then
    ROLE_ASSIGNMENT_ID=$(az role assignment list \
      --scope "${RESOURCE_GROUP_CORE_ID}" \
      --assignee "${GRAFANA_IDENTITY_PRINCIPAL_ID}" \
      --role "Monitoring Data Reader" \
      --query "[0].id" -o tsv 2>/dev/null || echo "")
    
    if [[ -n "${ROLE_ASSIGNMENT_ID}" ]]; then
      echo "  Importing azurerm_role_assignment.monitor_metrics_reader..."
      terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
        azurerm_role_assignment.monitor_metrics_reader \
        "${ROLE_ASSIGNMENT_ID}" 2>&1 | grep -v "^\[0m" || true
      if terraform state show azurerm_role_assignment.monitor_metrics_reader >/dev/null 2>&1; then
        echo "  ✓ Imported azurerm_role_assignment.monitor_metrics_reader"
      else
        echo "  ✗ FAILED to import azurerm_role_assignment.monitor_metrics_reader"
        exit 1
      fi
    else
      echo "  ⚠️  Could not retrieve role assignment ID from Azure"
      echo "  Importing azurerm_role_assignment.monitor_metrics_reader..."
      terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
        azurerm_role_assignment.monitor_metrics_reader \
        "${RESOURCE_GROUP_CORE_ID}|${GRAFANA_IDENTITY_PRINCIPAL_ID}|${ROLE_MONITORING_DATA_READER_ID}" 2>&1 | grep -v "^\[0m" || true
      if terraform state show azurerm_role_assignment.monitor_metrics_reader >/dev/null 2>&1; then
        echo "  ✓ Imported azurerm_role_assignment.monitor_metrics_reader"
      else
        echo "  ✗ FAILED to import azurerm_role_assignment.monitor_metrics_reader"
        exit 1
      fi
    fi
  else
    echo "  ⚠️  Skipping - role definition ID or principal ID not available"
  fi
else
  echo "  ✓ azurerm_role_assignment.monitor_metrics_reader already in state, skipping"
fi

# Telemetry Observer Group
echo ""
if ! terraform state show azurerm_role_assignment.telemetry_observer_group >/dev/null 2>&1; then
  if [[ -n "${TELEMETRY_OBSERVER_ROLE_ID}" ]] && [[ -n "${TELEMETRY_OBSERVER_GROUP_ID}" ]]; then
    ROLE_ASSIGNMENT_ID=$(az role assignment list \
      --scope "${RESOURCE_GROUP_CORE_ID}" \
      --assignee "${TELEMETRY_OBSERVER_GROUP_ID}" \
      --role "Telemetry Observer-test" \
      --query "[0].id" -o tsv 2>/dev/null || echo "")
    
    if [[ -n "${ROLE_ASSIGNMENT_ID}" ]]; then
      echo "  Importing azurerm_role_assignment.telemetry_observer_group..."
      terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
        azurerm_role_assignment.telemetry_observer_group \
        "${ROLE_ASSIGNMENT_ID}" 2>&1 | grep -v "^\[0m" || true
      if terraform state show azurerm_role_assignment.telemetry_observer_group >/dev/null 2>&1; then
        echo "  ✓ Imported azurerm_role_assignment.telemetry_observer_group"
      else
        echo "  ✗ FAILED to import azurerm_role_assignment.telemetry_observer_group"
        exit 1
      fi
    else
      echo "  ⚠️  Could not retrieve role assignment ID from Azure"
      echo "  Importing azurerm_role_assignment.telemetry_observer_group..."
      terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
        azurerm_role_assignment.telemetry_observer_group \
        "${RESOURCE_GROUP_CORE_ID}|${TELEMETRY_OBSERVER_GROUP_ID}|${TELEMETRY_OBSERVER_ROLE_ID}" 2>&1 | grep -v "^\[0m" || true
      if terraform state show azurerm_role_assignment.telemetry_observer_group >/dev/null 2>&1; then
        echo "  ✓ Imported azurerm_role_assignment.telemetry_observer_group"
      else
        echo "  ✗ FAILED to import azurerm_role_assignment.telemetry_observer_group"
        exit 1
      fi
    fi
  else
    echo "  ⚠️  Skipping - role definition ID or group ID not available (custom role may need manual lookup)"
  fi
else
  echo "  ✓ azurerm_role_assignment.telemetry_observer_group already in state, skipping"
fi

# Telemetry Observer Users
for USER_ID in "${USER_084A1C45}" "${USER_3B48F167}" "${USER_4B89A1F0}" "${USER_4EE4611F}"; do
  echo ""
  if ! terraform state show "azurerm_role_assignment.telemetry_observer_users[\"${USER_ID}\"]" >/dev/null 2>&1; then
    if [[ -n "${TELEMETRY_OBSERVER_ROLE_ID}" ]] && [[ -n "${USER_ID}" ]]; then
      ROLE_ASSIGNMENT_ID=$(az role assignment list \
        --scope "${RESOURCE_GROUP_CORE_ID}" \
        --assignee "${USER_ID}" \
        --role "Telemetry Observer-test" \
        --query "[0].id" -o tsv 2>/dev/null || echo "")
      
      if [[ -n "${ROLE_ASSIGNMENT_ID}" ]]; then
        echo "  Importing azurerm_role_assignment.telemetry_observer_users[\"${USER_ID}\"]..."
        terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
          "azurerm_role_assignment.telemetry_observer_users[\"${USER_ID}\"]" \
          "${ROLE_ASSIGNMENT_ID}" 2>&1 | grep -v "^\[0m" || true
        if terraform state show "azurerm_role_assignment.telemetry_observer_users[\"${USER_ID}\"]" >/dev/null 2>&1; then
          echo "  ✓ Imported azurerm_role_assignment.telemetry_observer_users[\"${USER_ID}\"]"
        else
          echo "  ✗ FAILED to import azurerm_role_assignment.telemetry_observer_users[\"${USER_ID}\"]"
          exit 1
        fi
      else
        echo "  ⚠️  Could not retrieve role assignment ID from Azure"
        echo "  Importing azurerm_role_assignment.telemetry_observer_users[\"${USER_ID}\"]..."
        terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
          "azurerm_role_assignment.telemetry_observer_users[\"${USER_ID}\"]" \
          "${RESOURCE_GROUP_CORE_ID}|${USER_ID}|${TELEMETRY_OBSERVER_ROLE_ID}" 2>&1 | grep -v "^\[0m" || true
        if terraform state show "azurerm_role_assignment.telemetry_observer_users[\"${USER_ID}\"]" >/dev/null 2>&1; then
          echo "  ✓ Imported azurerm_role_assignment.telemetry_observer_users[\"${USER_ID}\"]"
        else
          echo "  ✗ FAILED to import azurerm_role_assignment.telemetry_observer_users[\"${USER_ID}\"]"
          exit 1
        fi
      fi
    else
      echo "  ⚠️  Skipping - role definition ID or user ID not available (custom role may need manual lookup)"
    fi
  else
    echo "  ✓ azurerm_role_assignment.telemetry_observer_users[\"${USER_ID}\"] already in state, skipping"
  fi
done

# Terraform Service Principal - ACR Push
echo ""
if ! terraform state show azurerm_role_assignment.acrpush_terraform >/dev/null 2>&1; then
  if [[ -n "${ROLE_ACRPUSH_ID}" ]] && [[ -n "${TERRAFORM_SP_PRINCIPAL_ID}" ]]; then
    ROLE_ASSIGNMENT_ID=$(az role assignment list \
      --scope "${RESOURCE_GROUP_CORE_ID}" \
      --assignee "${TERRAFORM_SP_PRINCIPAL_ID}" \
      --role "AcrPush" \
      --query "[0].id" -o tsv 2>/dev/null || echo "")
    
    if [[ -n "${ROLE_ASSIGNMENT_ID}" ]]; then
      echo "  Importing azurerm_role_assignment.acrpush_terraform..."
      terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
        azurerm_role_assignment.acrpush_terraform \
        "${ROLE_ASSIGNMENT_ID}" 2>&1 | grep -v "^\[0m" || true
      if terraform state show azurerm_role_assignment.acrpush_terraform >/dev/null 2>&1; then
        echo "  ✓ Imported azurerm_role_assignment.acrpush_terraform"
      else
        echo "  ✗ FAILED to import azurerm_role_assignment.acrpush_terraform"
        exit 1
      fi
    else
      echo "  ⚠️  Could not retrieve role assignment ID from Azure"
      echo "  Importing azurerm_role_assignment.acrpush_terraform..."
      terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
        azurerm_role_assignment.acrpush_terraform \
        "${RESOURCE_GROUP_CORE_ID}|${TERRAFORM_SP_PRINCIPAL_ID}|${ROLE_ACRPUSH_ID}" 2>&1 | grep -v "^\[0m" || true
      if terraform state show azurerm_role_assignment.acrpush_terraform >/dev/null 2>&1; then
        echo "  ✓ Imported azurerm_role_assignment.acrpush_terraform"
      else
        echo "  ✗ FAILED to import azurerm_role_assignment.acrpush_terraform"
        exit 1
      fi
    fi
  else
    echo "  ⚠️  Skipping - role definition ID or principal ID not available"
  fi
else
  echo "  ✓ azurerm_role_assignment.acrpush_terraform already in state, skipping"
fi

# Terraform Service Principal - Key Vault assignments
echo ""
if ! terraform state show azurerm_role_assignment.kv_main_crypto_officer_terraform_assign >/dev/null 2>&1; then
  if [[ -n "${ROLE_KV_CRYPTO_OFFICER_ID}" ]] && [[ -n "${TERRAFORM_SP_PRINCIPAL_ID}" ]]; then
    ROLE_ASSIGNMENT_ID=$(az role assignment list \
      --scope "${KEY_VAULT_MAIN_ID}" \
      --assignee "${TERRAFORM_SP_PRINCIPAL_ID}" \
      --role "Key Vault Crypto Officer" \
      --query "[0].id" -o tsv 2>/dev/null || echo "")
    
    if [[ -n "${ROLE_ASSIGNMENT_ID}" ]]; then
      echo "  Importing azurerm_role_assignment.kv_main_crypto_officer_terraform_assign..."
      terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
        azurerm_role_assignment.kv_main_crypto_officer_terraform_assign \
        "${ROLE_ASSIGNMENT_ID}" 2>&1 | grep -v "^\[0m" || true
      if terraform state show azurerm_role_assignment.kv_main_crypto_officer_terraform_assign >/dev/null 2>&1; then
        echo "  ✓ Imported azurerm_role_assignment.kv_main_crypto_officer_terraform_assign"
      else
        echo "  ✗ FAILED to import azurerm_role_assignment.kv_main_crypto_officer_terraform_assign"
        exit 1
      fi
    else
      echo "  ⚠️  Could not retrieve role assignment ID from Azure"
      echo "  Importing azurerm_role_assignment.kv_main_crypto_officer_terraform_assign..."
      terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
        azurerm_role_assignment.kv_main_crypto_officer_terraform_assign \
        "${KEY_VAULT_MAIN_ID}|${TERRAFORM_SP_PRINCIPAL_ID}|${ROLE_KV_CRYPTO_OFFICER_ID}" 2>&1 | grep -v "^\[0m" || true
      if terraform state show azurerm_role_assignment.kv_main_crypto_officer_terraform_assign >/dev/null 2>&1; then
        echo "  ✓ Imported azurerm_role_assignment.kv_main_crypto_officer_terraform_assign"
      else
        echo "  ✗ FAILED to import azurerm_role_assignment.kv_main_crypto_officer_terraform_assign"
        exit 1
      fi
    fi
  else
    echo "  ⚠️  Skipping - role definition ID or principal ID not available"
  fi
else
  echo "  ✓ azurerm_role_assignment.kv_main_crypto_officer_terraform_assign already in state, skipping"
fi

echo ""
if ! terraform state show azurerm_role_assignment.kv_main_secrets_officer_terraform_assign >/dev/null 2>&1; then
  if [[ -n "${ROLE_KV_SECRETS_OFFICER_ID}" ]] && [[ -n "${TERRAFORM_SP_PRINCIPAL_ID}" ]]; then
    ROLE_ASSIGNMENT_ID=$(az role assignment list \
      --scope "${KEY_VAULT_MAIN_ID}" \
      --assignee "${TERRAFORM_SP_PRINCIPAL_ID}" \
      --role "Key Vault Secrets Officer" \
      --query "[0].id" -o tsv 2>/dev/null || echo "")
    
    if [[ -n "${ROLE_ASSIGNMENT_ID}" ]]; then
      echo "  Importing azurerm_role_assignment.kv_main_secrets_officer_terraform_assign..."
      terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
        azurerm_role_assignment.kv_main_secrets_officer_terraform_assign \
        "${ROLE_ASSIGNMENT_ID}" 2>&1 | grep -v "^\[0m" || true
      if terraform state show azurerm_role_assignment.kv_main_secrets_officer_terraform_assign >/dev/null 2>&1; then
        echo "  ✓ Imported azurerm_role_assignment.kv_main_secrets_officer_terraform_assign"
      else
        echo "  ✗ FAILED to import azurerm_role_assignment.kv_main_secrets_officer_terraform_assign"
        exit 1
      fi
    else
      echo "  ⚠️  Could not retrieve role assignment ID from Azure"
      echo "  Importing azurerm_role_assignment.kv_main_secrets_officer_terraform_assign..."
      terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
        azurerm_role_assignment.kv_main_secrets_officer_terraform_assign \
        "${KEY_VAULT_MAIN_ID}|${TERRAFORM_SP_PRINCIPAL_ID}|${ROLE_KV_SECRETS_OFFICER_ID}" 2>&1 | grep -v "^\[0m" || true
      if terraform state show azurerm_role_assignment.kv_main_secrets_officer_terraform_assign >/dev/null 2>&1; then
        echo "  ✓ Imported azurerm_role_assignment.kv_main_secrets_officer_terraform_assign"
      else
        echo "  ✗ FAILED to import azurerm_role_assignment.kv_main_secrets_officer_terraform_assign"
        exit 1
      fi
    fi
  else
    echo "  ⚠️  Skipping - role definition ID or principal ID not available"
  fi
else
  echo "  ✓ azurerm_role_assignment.kv_main_secrets_officer_terraform_assign already in state, skipping"
fi

echo ""
if ! terraform state show azurerm_role_assignment.kv_main_access_administrator_terraform_assign >/dev/null 2>&1; then
  if [[ -n "${ROLE_KV_DATA_ACCESS_ADMIN_ID}" ]] && [[ -n "${TERRAFORM_SP_PRINCIPAL_ID}" ]]; then
    ROLE_ASSIGNMENT_ID=$(az role assignment list \
      --scope "${KEY_VAULT_MAIN_ID}" \
      --assignee "${TERRAFORM_SP_PRINCIPAL_ID}" \
      --role "Key Vault Data Access Administrator" \
      --query "[0].id" -o tsv 2>/dev/null || echo "")
    
    if [[ -n "${ROLE_ASSIGNMENT_ID}" ]]; then
      echo "  Importing azurerm_role_assignment.kv_main_access_administrator_terraform_assign..."
      terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
        azurerm_role_assignment.kv_main_access_administrator_terraform_assign \
        "${ROLE_ASSIGNMENT_ID}" 2>&1 | grep -v "^\[0m" || true
      if terraform state show azurerm_role_assignment.kv_main_access_administrator_terraform_assign >/dev/null 2>&1; then
        echo "  ✓ Imported azurerm_role_assignment.kv_main_access_administrator_terraform_assign"
      else
        echo "  ✗ FAILED to import azurerm_role_assignment.kv_main_access_administrator_terraform_assign"
        exit 1
      fi
    else
      echo "  ⚠️  Could not retrieve role assignment ID from Azure"
      echo "  Importing azurerm_role_assignment.kv_main_access_administrator_terraform_assign..."
      terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
        azurerm_role_assignment.kv_main_access_administrator_terraform_assign \
        "${KEY_VAULT_MAIN_ID}|${TERRAFORM_SP_PRINCIPAL_ID}|${ROLE_KV_DATA_ACCESS_ADMIN_ID}" 2>&1 | grep -v "^\[0m" || true
      if terraform state show azurerm_role_assignment.kv_main_access_administrator_terraform_assign >/dev/null 2>&1; then
        echo "  ✓ Imported azurerm_role_assignment.kv_main_access_administrator_terraform_assign"
      else
        echo "  ✗ FAILED to import azurerm_role_assignment.kv_main_access_administrator_terraform_assign"
        exit 1
      fi
    fi
  else
    echo "  ⚠️  Skipping - role definition ID or principal ID not available"
  fi
else
  echo "  ✓ azurerm_role_assignment.kv_main_access_administrator_terraform_assign already in state, skipping"
fi

echo ""
if ! terraform state show azurerm_role_assignment.kv_crypto_officer_terraform_assign >/dev/null 2>&1; then
  if [[ -n "${ROLE_KV_CRYPTO_OFFICER_ID}" ]] && [[ -n "${TERRAFORM_SP_PRINCIPAL_ID}" ]]; then
    ROLE_ASSIGNMENT_ID=$(az role assignment list \
      --scope "${KEY_VAULT_SENSITIVE_ID}" \
      --assignee "${TERRAFORM_SP_PRINCIPAL_ID}" \
      --role "Key Vault Crypto Officer" \
      --query "[0].id" -o tsv 2>/dev/null || echo "")
    
    if [[ -n "${ROLE_ASSIGNMENT_ID}" ]]; then
      echo "  Importing azurerm_role_assignment.kv_crypto_officer_terraform_assign..."
      terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
        azurerm_role_assignment.kv_crypto_officer_terraform_assign \
        "${ROLE_ASSIGNMENT_ID}" 2>&1 | grep -v "^\[0m" || true
      if terraform state show azurerm_role_assignment.kv_crypto_officer_terraform_assign >/dev/null 2>&1; then
        echo "  ✓ Imported azurerm_role_assignment.kv_crypto_officer_terraform_assign"
      else
        echo "  ✗ FAILED to import azurerm_role_assignment.kv_crypto_officer_terraform_assign"
        exit 1
      fi
    else
      echo "  ⚠️  Could not retrieve role assignment ID from Azure"
      echo "  Importing azurerm_role_assignment.kv_crypto_officer_terraform_assign..."
      terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
        azurerm_role_assignment.kv_crypto_officer_terraform_assign \
        "${KEY_VAULT_SENSITIVE_ID}|${TERRAFORM_SP_PRINCIPAL_ID}|${ROLE_KV_CRYPTO_OFFICER_ID}" 2>&1 | grep -v "^\[0m" || true
      if terraform state show azurerm_role_assignment.kv_crypto_officer_terraform_assign >/dev/null 2>&1; then
        echo "  ✓ Imported azurerm_role_assignment.kv_crypto_officer_terraform_assign"
      else
        echo "  ✗ FAILED to import azurerm_role_assignment.kv_crypto_officer_terraform_assign"
        exit 1
      fi
    fi
  else
    echo "  ⚠️  Skipping - role definition ID or principal ID not available"
  fi
else
  echo "  ✓ azurerm_role_assignment.kv_crypto_officer_terraform_assign already in state, skipping"
fi

echo ""
if ! terraform state show azurerm_role_assignment.kv_secrets_officer_terraform_assign >/dev/null 2>&1; then
  if [[ -n "${ROLE_KV_SECRETS_OFFICER_ID}" ]] && [[ -n "${TERRAFORM_SP_PRINCIPAL_ID}" ]]; then
    ROLE_ASSIGNMENT_ID=$(az role assignment list \
      --scope "${KEY_VAULT_SENSITIVE_ID}" \
      --assignee "${TERRAFORM_SP_PRINCIPAL_ID}" \
      --role "Key Vault Secrets Officer" \
      --query "[0].id" -o tsv 2>/dev/null || echo "")
    
    if [[ -n "${ROLE_ASSIGNMENT_ID}" ]]; then
      echo "  Importing azurerm_role_assignment.kv_secrets_officer_terraform_assign..."
      terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
        azurerm_role_assignment.kv_secrets_officer_terraform_assign \
        "${ROLE_ASSIGNMENT_ID}" 2>&1 | grep -v "^\[0m" || true
      if terraform state show azurerm_role_assignment.kv_secrets_officer_terraform_assign >/dev/null 2>&1; then
        echo "  ✓ Imported azurerm_role_assignment.kv_secrets_officer_terraform_assign"
      else
        echo "  ✗ FAILED to import azurerm_role_assignment.kv_secrets_officer_terraform_assign"
        exit 1
      fi
    else
      echo "  ⚠️  Could not retrieve role assignment ID from Azure"
      echo "  Importing azurerm_role_assignment.kv_secrets_officer_terraform_assign..."
      terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
        azurerm_role_assignment.kv_secrets_officer_terraform_assign \
        "${KEY_VAULT_SENSITIVE_ID}|${TERRAFORM_SP_PRINCIPAL_ID}|${ROLE_KV_SECRETS_OFFICER_ID}" 2>&1 | grep -v "^\[0m" || true
      if terraform state show azurerm_role_assignment.kv_secrets_officer_terraform_assign >/dev/null 2>&1; then
        echo "  ✓ Imported azurerm_role_assignment.kv_secrets_officer_terraform_assign"
      else
        echo "  ✗ FAILED to import azurerm_role_assignment.kv_secrets_officer_terraform_assign"
        exit 1
      fi
    fi
  else
    echo "  ⚠️  Skipping - role definition ID or principal ID not available"
  fi
else
  echo "  ✓ azurerm_role_assignment.kv_secrets_officer_terraform_assign already in state, skipping"
fi

echo ""
if ! terraform state show azurerm_role_assignment.kv_access_administrator_terraform_assign >/dev/null 2>&1; then
  if [[ -n "${ROLE_KV_DATA_ACCESS_ADMIN_ID}" ]] && [[ -n "${TERRAFORM_SP_PRINCIPAL_ID}" ]]; then
    ROLE_ASSIGNMENT_ID=$(az role assignment list \
      --scope "${KEY_VAULT_SENSITIVE_ID}" \
      --assignee "${TERRAFORM_SP_PRINCIPAL_ID}" \
      --role "Key Vault Data Access Administrator" \
      --query "[0].id" -o tsv 2>/dev/null || echo "")
    
    if [[ -n "${ROLE_ASSIGNMENT_ID}" ]]; then
      echo "  Importing azurerm_role_assignment.kv_access_administrator_terraform_assign..."
      terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
        azurerm_role_assignment.kv_access_administrator_terraform_assign \
        "${ROLE_ASSIGNMENT_ID}" 2>&1 | grep -v "^\[0m" || true
      if terraform state show azurerm_role_assignment.kv_access_administrator_terraform_assign >/dev/null 2>&1; then
        echo "  ✓ Imported azurerm_role_assignment.kv_access_administrator_terraform_assign"
      else
        echo "  ✗ FAILED to import azurerm_role_assignment.kv_access_administrator_terraform_assign"
        exit 1
      fi
    else
      echo "  ⚠️  Could not retrieve role assignment ID from Azure"
      echo "  Importing azurerm_role_assignment.kv_access_administrator_terraform_assign..."
      terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
        azurerm_role_assignment.kv_access_administrator_terraform_assign \
        "${KEY_VAULT_SENSITIVE_ID}|${TERRAFORM_SP_PRINCIPAL_ID}|${ROLE_KV_DATA_ACCESS_ADMIN_ID}" 2>&1 | grep -v "^\[0m" || true
      if terraform state show azurerm_role_assignment.kv_access_administrator_terraform_assign >/dev/null 2>&1; then
        echo "  ✓ Imported azurerm_role_assignment.kv_access_administrator_terraform_assign"
      else
        echo "  ✗ FAILED to import azurerm_role_assignment.kv_access_administrator_terraform_assign"
        exit 1
      fi
    fi
  else
    echo "  ⚠️  Skipping - role definition ID or principal ID not available"
  fi
else
  echo "  ✓ azurerm_role_assignment.kv_access_administrator_terraform_assign already in state, skipping"
fi

echo ""
echo "⚠️  Note: Some role assignments may require manual import if role definition IDs could not be retrieved."
echo "   To get custom role definition IDs, run:"
echo "   az role definition list --scope \"/subscriptions/${SUBSCRIPTION_ID}\" --query '[?contains(name, \"Telemetry\") || contains(name, \"AcrPull\") || contains(name, \"VNet\")].{name:name,id:id}' -o table"
echo ""

echo ""
echo "=========================================="
echo "Note on Configuration Updates"
echo "=========================================="
echo ""
echo "The following resources may show as 'will be updated' in terraform plan:"
echo "  - azuread_service_principal.msgraph (adding use_existing = true)"
echo "  - module.application_registration.azuread_application.this (redirect_uri changes)"
echo ""
echo "These are configuration updates, not imports. They will be applied on the next"
echo "terraform apply and are expected behavior."
echo ""

echo ""
echo "=========================================="
echo "Importing Application Gateway Resources"
echo "=========================================="
echo ""

# Application Gateway Public IP
echo "Checking azurerm_public_ip.application_gateway_public_ip..."
if ! terraform state show azurerm_public_ip.application_gateway_public_ip >/dev/null 2>&1; then
  # Get public IP name from terraform plan or use default
  PUBLIC_IP_NAME="default-public-ip-name"
  PUBLIC_IP_ID=$(az network public-ip show \
    --name "${PUBLIC_IP_NAME}" \
    --resource-group "${RESOURCE_GROUP_CORE_NAME}" \
    --query id -o tsv 2>/dev/null || echo "")
  
  if [[ -n "${PUBLIC_IP_ID}" ]]; then
    echo "  Importing azurerm_public_ip.application_gateway_public_ip..."
    terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
      azurerm_public_ip.application_gateway_public_ip \
      "${PUBLIC_IP_ID}" 2>&1 | grep -v "^\[0m" || true
    if terraform state show azurerm_public_ip.application_gateway_public_ip >/dev/null 2>&1; then
      echo "  ✓ Imported azurerm_public_ip.application_gateway_public_ip"
    else
      echo "  ✗ FAILED to import azurerm_public_ip.application_gateway_public_ip"
      exit 1
    fi
  else
    echo "  ⚠️  Could not retrieve public IP ID from Azure"
    echo "     Public IP name: ${PUBLIC_IP_NAME}"
    echo "     Resource group: ${RESOURCE_GROUP_CORE_NAME}"
    echo "     You may need to import manually using the resource ID"
  fi
else
  echo "  ✓ azurerm_public_ip.application_gateway_public_ip already in state, skipping"
fi

# Application Gateway
echo ""
echo "Checking module.application_gateway.azurerm_application_gateway.appgw..."
if ! terraform state show 'module.application_gateway.azurerm_application_gateway.appgw' >/dev/null 2>&1; then
  APPLICATION_GATEWAY_NAME="ha-test-appgw"
  APPLICATION_GATEWAY_ID=$(az network application-gateway show \
    --name "${APPLICATION_GATEWAY_NAME}" \
    --resource-group "${RESOURCE_GROUP_CORE_NAME}" \
    --query id -o tsv 2>/dev/null || echo "")
  
  if [[ -n "${APPLICATION_GATEWAY_ID}" ]]; then
    echo "  Importing module.application_gateway.azurerm_application_gateway.appgw..."
    terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
      'module.application_gateway.azurerm_application_gateway.appgw' \
      "${APPLICATION_GATEWAY_ID}" 2>&1 | grep -v "^\[0m" || true
    if terraform state show 'module.application_gateway.azurerm_application_gateway.appgw' >/dev/null 2>&1; then
      echo "  ✓ Imported module.application_gateway.azurerm_application_gateway.appgw"
    else
      echo "  ✗ FAILED to import module.application_gateway.azurerm_application_gateway.appgw"
      exit 1
    fi
  else
    echo "  ⚠️  Could not retrieve Application Gateway ID from Azure"
    echo "     Application Gateway name: ${APPLICATION_GATEWAY_NAME}"
    echo "     Resource group: ${RESOURCE_GROUP_CORE_NAME}"
    echo "     You may need to import manually using the resource ID"
  fi
else
  echo "  ✓ module.application_gateway.azurerm_application_gateway.appgw already in state, skipping"
fi

# Application Gateway WAF Policy
echo ""
echo "Checking module.application_gateway.azurerm_web_application_firewall_policy.wafpolicy[0]..."
if ! terraform state show 'module.application_gateway.azurerm_web_application_firewall_policy.wafpolicy[0]' >/dev/null 2>&1; then
  WAF_POLICY_NAME="default-waf-policy-name"
  WAF_POLICY_ID=$(az network application-gateway waf-policy show \
    --name "${WAF_POLICY_NAME}" \
    --resource-group "${RESOURCE_GROUP_CORE_NAME}" \
    --query id -o tsv 2>/dev/null || echo "")
  
  if [[ -n "${WAF_POLICY_ID}" ]]; then
    # Fix casing: Azure CLI returns ApplicationGatewayWebApplicationFirewallPolicies
    # but Terraform expects applicationGatewayWebApplicationFirewallPolicies
    WAF_POLICY_ID_FIXED=$(echo "${WAF_POLICY_ID}" | sed 's|/ApplicationGatewayWebApplicationFirewallPolicies/|/applicationGatewayWebApplicationFirewallPolicies/|')
    echo "  Importing module.application_gateway.azurerm_web_application_firewall_policy.wafpolicy[0]..."
    terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
      'module.application_gateway.azurerm_web_application_firewall_policy.wafpolicy[0]' \
      "${WAF_POLICY_ID_FIXED}" 2>&1 | grep -v "^\[0m" || true
    if terraform state show 'module.application_gateway.azurerm_web_application_firewall_policy.wafpolicy[0]' >/dev/null 2>&1; then
      echo "  ✓ Imported module.application_gateway.azurerm_web_application_firewall_policy.wafpolicy[0]"
    else
      echo "  ✗ FAILED to import module.application_gateway.azurerm_web_application_firewall_policy.wafpolicy[0]"
      exit 1
    fi
  else
    echo "  ⚠️  Could not retrieve WAF Policy ID from Azure"
    echo "     WAF Policy name: ${WAF_POLICY_NAME}"
    echo "     Resource group: ${RESOURCE_GROUP_CORE_NAME}"
    echo "     You may need to import manually using the resource ID"
  fi
else
  echo "  ✓ module.application_gateway.azurerm_web_application_firewall_policy.wafpolicy[0] already in state, skipping"
fi

# Application Gateway Diagnostic Setting
echo ""
echo "Checking module.application_gateway.azurerm_monitor_diagnostic_setting.agw_diagnostic[0]..."
if ! terraform state show 'module.application_gateway.azurerm_monitor_diagnostic_setting.agw_diagnostic[0]' >/dev/null 2>&1; then
  # Diagnostic settings use a composite ID: <target-resource-id>|providers/Microsoft.Insights/diagnosticSettings/<diagnostic-setting-name>
  APPLICATION_GATEWAY_NAME="ha-test-appgw"
  DIAGNOSTIC_SETTING_NAME="log-ha-test-appgw"
  APPLICATION_GATEWAY_ID=$(az network application-gateway show \
    --name "${APPLICATION_GATEWAY_NAME}" \
    --resource-group "${RESOURCE_GROUP_CORE_NAME}" \
    --query id -o tsv 2>/dev/null || echo "")
  
  if [[ -n "${APPLICATION_GATEWAY_ID}" ]]; then
    # Check if diagnostic setting exists in Azure
    DIAGNOSTIC_SETTING_EXISTS=$(az monitor diagnostic-settings list \
      --resource "${APPLICATION_GATEWAY_ID}" \
      --query "[?name=='${DIAGNOSTIC_SETTING_NAME}'].name" -o tsv 2>/dev/null || echo "")
    
    if [[ -n "${DIAGNOSTIC_SETTING_EXISTS}" ]]; then
      DIAGNOSTIC_SETTING_ID="${APPLICATION_GATEWAY_ID}|providers/Microsoft.Insights/diagnosticSettings/${DIAGNOSTIC_SETTING_NAME}"
      echo "  Importing module.application_gateway.azurerm_monitor_diagnostic_setting.agw_diagnostic[0]..."
      IMPORT_OUTPUT=$(terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
        'module.application_gateway.azurerm_monitor_diagnostic_setting.agw_diagnostic[0]' \
        "${DIAGNOSTIC_SETTING_ID}" 2>&1)
      IMPORT_EXIT_CODE=$?
      
      if [[ ${IMPORT_EXIT_CODE} -eq 0 ]] && terraform state show 'module.application_gateway.azurerm_monitor_diagnostic_setting.agw_diagnostic[0]' >/dev/null 2>&1; then
        echo "  ✓ Imported module.application_gateway.azurerm_monitor_diagnostic_setting.agw_diagnostic[0]"
      elif echo "${IMPORT_OUTPUT}" | grep -q "ResourceTypeNotSupported\|does not support diagnostic settings"; then
        echo "  ⚠️  Diagnostic setting cannot be imported (resource type limitation)"
        echo "     Terraform will create it on the next apply. This is expected behavior."
      else
        echo "  ⚠️  Failed to import diagnostic setting (exit code: ${IMPORT_EXIT_CODE})"
        echo "     Terraform will create it on the next apply. This is expected behavior."
      fi
    else
      echo "  ⚠️  Diagnostic setting '${DIAGNOSTIC_SETTING_NAME}' does not exist in Azure"
      echo "     Terraform will create it on the next apply. Skipping import."
    fi
  else
    echo "  ⚠️  Could not retrieve Application Gateway ID from Azure"
    echo "     Terraform will create the diagnostic setting on the next apply. Skipping import."
  fi
else
  echo "  ✓ module.application_gateway.azurerm_monitor_diagnostic_setting.agw_diagnostic[0] already in state, skipping"
fi

# Application Gateway Metric Alert
echo ""
echo "Checking module.application_gateway.azurerm_monitor_metric_alert.application_gateway_metric_alerts[\"default_5xx_error_alert\"]..."
if ! terraform state show 'module.application_gateway.azurerm_monitor_metric_alert.application_gateway_metric_alerts["default_5xx_error_alert"]' >/dev/null 2>&1; then
  METRIC_ALERT_NAME="Application Gateway 5xx Error"
  METRIC_ALERT_ID=$(az monitor metrics alert show \
    --name "${METRIC_ALERT_NAME}" \
    --resource-group "${RESOURCE_GROUP_CORE_NAME}" \
    --query id -o tsv 2>/dev/null || echo "")
  
  if [[ -n "${METRIC_ALERT_ID}" ]]; then
    echo "  Importing module.application_gateway.azurerm_monitor_metric_alert.application_gateway_metric_alerts[\"default_5xx_error_alert\"]..."
    terraform import -var-file="${VAR_CONFIG}" -var-file="${VAR_PARAMS}" \
      'module.application_gateway.azurerm_monitor_metric_alert.application_gateway_metric_alerts["default_5xx_error_alert"]' \
      "${METRIC_ALERT_ID}" 2>&1 | grep -v "^\[0m" || true
    if terraform state show 'module.application_gateway.azurerm_monitor_metric_alert.application_gateway_metric_alerts["default_5xx_error_alert"]' >/dev/null 2>&1; then
      echo "  ✓ Imported module.application_gateway.azurerm_monitor_metric_alert.application_gateway_metric_alerts[\"default_5xx_error_alert\"]"
    else
      echo "  ✗ FAILED to import module.application_gateway.azurerm_monitor_metric_alert.application_gateway_metric_alerts[\"default_5xx_error_alert\"]"
      exit 1
    fi
  else
    echo "  ⚠️  Could not retrieve Metric Alert ID from Azure"
    echo "     Metric Alert name: ${METRIC_ALERT_NAME}"
    echo "     Resource group: ${RESOURCE_GROUP_CORE_NAME}"
    echo "     You may need to import manually using the resource ID"
  fi
else
  echo "  ✓ module.application_gateway.azurerm_monitor_metric_alert.application_gateway_metric_alerts[\"default_5xx_error_alert\"] already in state, skipping"
fi

echo ""
echo "=========================================="
echo "Application Registration Drifts (3-5)"
echo "=========================================="
echo ""
echo "The following resources may show as drifts in terraform plan:"
echo ""
echo "3. module.application_registration.azuread_application_password.aad_app_password[0]"
echo "   - Drift: Will be created (expected behavior)"
echo "   - Reason: azuread_application_password does NOT support import."
echo "             The password value is only available at creation time and cannot"
echo "             be retrieved from Azure AD."
echo "   - Resolution: Let Terraform create it fresh. This will regenerate the password,"
echo "                 which is expected and safe - the module will update the Key Vault"
echo "                 secret with the new password value."
echo ""
echo "4. module.application_registration.azurerm_key_vault_secret.aad_app_gitops_client_id[0]"
echo "   - Drift: Will be created (if not already imported)"
echo "   - Reason: Terraform requires versioned secret IDs for import."
echo "             Format: https://{vault}.vault.azure.net/secrets/{name}/{version-id}"
echo "   - Resolution:"
echo "     1. If the secret already exists in Azure, import it manually:"
echo "        az keyvault secret show --vault-name hakv2testv2 --name aad-app-ha-test-gitops-client-id --query id -o tsv"
echo "        terraform import -var-file=\"${VAR_CONFIG}\" -var-file=\"${VAR_PARAMS}\" \\"
echo "          'module.application_registration.azurerm_key_vault_secret.aad_app_gitops_client_id[0]' \\"
echo "          '<versioned-id-from-az-command>'"
echo "     2. If the secret doesn't exist, let Terraform create it (recommended)"
echo ""
echo "5. module.application_registration.azurerm_key_vault_secret.aad_app_gitops_client_secret[0]"
echo "   - Drift: Will be created (if not already imported)"
echo "   - Reason: Terraform requires versioned secret IDs for import."
echo "             Format: https://{vault}.vault.azure.net/secrets/{name}/{version-id}"
echo "   - Resolution:"
echo "     1. If the secret already exists in Azure, import it manually:"
echo "        az keyvault secret show --vault-name hakv2testv2 --name aad-app-ha-test-gitops-client-secret --query id -o tsv"
echo "        terraform import -var-file=\"${VAR_CONFIG}\" -var-file=\"${VAR_PARAMS}\" \\"
echo "          'module.application_registration.azurerm_key_vault_secret.aad_app_gitops_client_secret[0]' \\"
echo "          '<versioned-id-from-az-command>'"
echo "     2. If the secret doesn't exist, let Terraform create it (recommended)"
echo ""
echo "Note: These resources are managed by the application_registration module and"
echo "      are created as part of the module's client_secret_generation_config."
echo ""
echo "=========================================="
echo "Import script completed!"
echo "=========================================="
echo ""
